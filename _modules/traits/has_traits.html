
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>traits.has_traits &#8212; OpenPNM 2.8.2 documentation</title>
    
  <link href="../../_static/css/theme.css" rel="stylesheet">
  <link href="../../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/blank.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css" />
    
  <link rel="preload" as="script" href="../../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../_static/js/custom.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    

<a class="navbar-brand" href="https://www.openpnm.org">
  <img src="../../_static/openpnm_logo.png" class="logo" alt="logo">
</a>


    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class=" collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../user_guide/installation.html">
  Installation
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../user_guide/index.html">
  User Guide
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../modules/index.html">
  Module Reference
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../examples/examples.html">
  Examples
 </a>
</li>

    
    <li class="nav-item">
        <a class="nav-link nav-external" href="https://github.com/PMEAL/OpenPNM/issues">Issue Tracker<i class="fas fa-external-link-alt"></i></a>
    </li>
    
    <li class="nav-item">
        <a class="nav-link nav-external" href="https://github.com/PMEAL/OpenPNM/discussions">Get Help<i class="fas fa-external-link-alt"></i></a>
    </li>
    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Quick Links">
        <li class="nav-item">
          <a class="nav-link" href="https://github.com/PMEAL/OpenPNM" rel="noopener" target="_blank" title="GitHub">
            <span><i class="fab fa-github-square"></i></span>
            <label class="sr-only">GitHub</label>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://openpnm.substack.com/" rel="noopener" target="_blank" title="Substack">
            <span><i class="fas fa-envelope-square"></i></span>
            <label class="sr-only">Substack</label>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://twitter.com/OpenPNM" rel="noopener" target="_blank" title="Twitter">
            <span><i class="fab fa-twitter-square"></i></span>
            <label class="sr-only">Twitter</label>
          </a>
        </li>
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar"><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    
  </div>
</nav>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <h1>Source code for traits.has_traits</h1><div class="highlight"><pre>
<span></span><span class="c1"># (C) Copyright 2005-2021 Enthought, Inc., Austin, TX</span>
<span class="c1"># All rights reserved.</span>
<span class="c1">#</span>
<span class="c1"># This software is provided without warranty under the terms of the BSD</span>
<span class="c1"># license included in LICENSE.txt and may be redistributed only under</span>
<span class="c1"># the conditions described in the aforementioned license. The license</span>
<span class="c1"># is also available online at http://www.enthought.com/licenses/BSD.txt</span>
<span class="c1">#</span>
<span class="c1"># Thanks for using Enthought open source!</span>

<span class="sd">&quot;&quot;&quot; Defines the HasTraits class, along with several useful subclasses and</span>
<span class="sd">    associated metaclasses.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">abc</span>
<span class="kn">import</span> <span class="nn">copy</span> <span class="k">as</span> <span class="nn">copy_module</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">weakref</span>

<span class="kn">from</span> <span class="nn">types</span> <span class="kn">import</span> <span class="n">FunctionType</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">__version__</span> <span class="k">as</span> <span class="n">TraitsVersion</span>
<span class="kn">from</span> <span class="nn">.adaptation.adaptation_error</span> <span class="kn">import</span> <span class="n">AdaptationError</span>
<span class="kn">from</span> <span class="nn">.constants</span> <span class="kn">import</span> <span class="n">DefaultValue</span><span class="p">,</span> <span class="n">TraitKind</span>
<span class="kn">from</span> <span class="nn">.ctrait</span> <span class="kn">import</span> <span class="n">CTrait</span><span class="p">,</span> <span class="n">__newobj__</span>
<span class="kn">from</span> <span class="nn">.ctraits</span> <span class="kn">import</span> <span class="n">CHasTraits</span>
<span class="kn">from</span> <span class="nn">.observation</span> <span class="kn">import</span> <span class="n">api</span> <span class="k">as</span> <span class="n">observe_api</span>
<span class="kn">from</span> <span class="nn">.traits</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">ForwardProperty</span><span class="p">,</span>
    <span class="n">Property</span><span class="p">,</span>
    <span class="n">Trait</span><span class="p">,</span>
    <span class="n">generic_trait</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.trait_types</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Bool</span><span class="p">,</span> <span class="n">Disallow</span><span class="p">,</span> <span class="n">Event</span><span class="p">,</span> <span class="n">Python</span><span class="p">,</span> <span class="n">Str</span>
<span class="kn">from</span> <span class="nn">.trait_notifiers</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">ExtendedTraitChangeNotifyWrapper</span><span class="p">,</span>
    <span class="n">FastUITraitChangeNotifyWrapper</span><span class="p">,</span>
    <span class="n">NewTraitChangeNotifyWrapper</span><span class="p">,</span>
    <span class="n">StaticAnytraitChangeNotifyWrapper</span><span class="p">,</span>
    <span class="n">StaticTraitChangeNotifyWrapper</span><span class="p">,</span>
    <span class="n">TraitChangeNotifyWrapper</span><span class="p">,</span>
    <span class="n">ui_dispatch</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.trait_base</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">SequenceTypes</span><span class="p">,</span>
    <span class="n">TraitsCache</span><span class="p">,</span>
    <span class="n">Undefined</span><span class="p">,</span>
    <span class="n">is_none</span><span class="p">,</span>
    <span class="n">not_event</span><span class="p">,</span>
    <span class="n">not_false</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.trait_errors</span> <span class="kn">import</span> <span class="n">TraitError</span>
<span class="kn">from</span> <span class="nn">.util.deprecated</span> <span class="kn">import</span> <span class="n">deprecated</span>
<span class="kn">from</span> <span class="nn">.util._traitsui_helpers</span> <span class="kn">import</span> <span class="n">check_traitsui_major_version</span>
<span class="kn">from</span> <span class="nn">.trait_converters</span> <span class="kn">import</span> <span class="n">check_trait</span><span class="p">,</span> <span class="n">mapped_trait_for</span><span class="p">,</span> <span class="n">trait_for</span>


<span class="c1">#  Set CHECK_INTERFACES to one of the following values:</span>
<span class="c1">#</span>
<span class="c1">#  - 0: Does not check to see if classes implement their declared interfaces.</span>
<span class="c1">#  - 1: Ensures that classes implement the interfaces they say they do, and</span>
<span class="c1">#       logs a warning if they don&#39;t.</span>
<span class="c1">#  - 2: Ensures that classes implement the interfaces they say they do, and</span>
<span class="c1">#       raises an InterfaceError if they don&#39;t.</span>
<span class="c1">#</span>
<span class="c1">#  This constant is used by the @provides decorator when deciding whether to</span>
<span class="c1">#  do interface checking. This behaviour is deprecated. In the future, the</span>
<span class="c1">#  provides decorator will no longer perform interface checking, regardless of</span>
<span class="c1">#  the value of this constant.</span>

<span class="n">CHECK_INTERFACES</span> <span class="o">=</span> <span class="mi">0</span>


<span class="c1">#  This ABC is a placeholder for the TraitsUI ViewElement class, which should</span>
<span class="c1">#  inherit from or register as implementing the API.  This has to be done here</span>
<span class="c1">#  so that the metaclass machinery has something to check against when</span>
<span class="c1">#  filtering out TraitsUI elements that are declared as part of a HasTraits</span>
<span class="c1">#  class.</span>

<span class="k">class</span> <span class="nc">AbstractViewElement</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="c1"># Constants</span>

<span class="n">WrapperTypes</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">StaticAnytraitChangeNotifyWrapper</span><span class="p">,</span>
    <span class="n">StaticTraitChangeNotifyWrapper</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Class dictionary entries used to save trait, listener and view information</span>
<span class="c1"># and definitions:</span>

<span class="n">BaseTraits</span> <span class="o">=</span> <span class="s2">&quot;__base_traits__&quot;</span>
<span class="n">ClassTraits</span> <span class="o">=</span> <span class="s2">&quot;__class_traits__&quot;</span>
<span class="n">PrefixTraits</span> <span class="o">=</span> <span class="s2">&quot;__prefix_traits__&quot;</span>
<span class="n">ListenerTraits</span> <span class="o">=</span> <span class="s2">&quot;__listener_traits__&quot;</span>
<span class="n">ObserverTraits</span> <span class="o">=</span> <span class="s2">&quot;__observer_traits__&quot;</span>
<span class="n">ViewTraits</span> <span class="o">=</span> <span class="s2">&quot;__view_traits__&quot;</span>
<span class="n">InstanceTraits</span> <span class="o">=</span> <span class="s2">&quot;__instance_traits__&quot;</span>

<span class="c1"># The default Traits View name</span>
<span class="n">DefaultTraitsView</span> <span class="o">=</span> <span class="s2">&quot;traits_view&quot;</span>

<span class="c1"># Trait types which cannot have default values</span>
<span class="n">CantHaveDefaultValue</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;event&quot;</span><span class="p">,</span> <span class="s2">&quot;delegate&quot;</span><span class="p">,</span> <span class="s2">&quot;constant&quot;</span><span class="p">)</span>

<span class="c1"># The trait types that should be copied last when doing a &#39;copy_traits&#39;:</span>
<span class="n">DeferredCopy</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;delegate&quot;</span><span class="p">,</span> <span class="s2">&quot;property&quot;</span><span class="p">)</span>

<span class="c1"># Quick test for normal vs extended trait name</span>
<span class="n">extended_trait_pat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;.*[ :\+\-,\.\*\?\[\]]&quot;</span><span class="p">)</span>

<span class="c1"># Generic &#39;Any&#39; trait:</span>
<span class="n">any_trait</span> <span class="o">=</span> <span class="n">Any</span><span class="p">()</span><span class="o">.</span><span class="n">as_ctrait</span><span class="p">()</span>

<span class="c1"># Mapping from user-facing strings to the dispatcher callable in observe.</span>
<span class="n">_ObserverDispatchers</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;same&quot;</span><span class="p">:</span> <span class="n">observe_api</span><span class="o">.</span><span class="n">dispatch_same</span><span class="p">,</span>
    <span class="s2">&quot;ui&quot;</span><span class="p">:</span> <span class="n">ui_dispatch</span><span class="p">,</span>
<span class="p">}</span>


<span class="k">def</span> <span class="nf">_clone_trait</span><span class="p">(</span><span class="n">clone</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Creates a clone of a specified trait.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">trait</span> <span class="o">=</span> <span class="n">CTrait</span><span class="p">(</span><span class="n">TraitKind</span><span class="o">.</span><span class="n">trait</span><span class="p">)</span>
    <span class="n">trait</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">clone</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">clone</span><span class="o">.</span><span class="vm">__dict__</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">trait</span><span class="o">.</span><span class="vm">__dict__</span> <span class="o">=</span> <span class="n">clone</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">trait</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">trait</span>


<span class="k">def</span> <span class="nf">_get_method</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Get the definition of a specified method (if any). &quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">is_unbound_method_type</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">_get_def</span><span class="p">(</span><span class="n">class_name</span><span class="p">,</span> <span class="n">class_dict</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Gets the definition of a specified method (if any).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">method</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;__&quot;</span><span class="p">:</span>
        <span class="c1"># When name-mangling to handle the __ case (for _private traits),</span>
        <span class="c1"># leading underscores in the class name are stripped out.</span>
        <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;_</span><span class="si">%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">class_name</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">),</span> <span class="n">method</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">class_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
        <span class="ow">and</span> <span class="n">is_unbound_method_type</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="ow">and</span> <span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s2">&quot;on_trait_change&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
        <span class="ow">and</span> <span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s2">&quot;_observe_inputs&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="n">bases</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">is_unbound_method_type</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="ow">and</span> <span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s2">&quot;on_trait_change&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
            <span class="ow">and</span> <span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s2">&quot;_observe_inputs&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="n">result</span>

    <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">is_unbound_method_type</span><span class="p">(</span><span class="n">method</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Check for something that looks like an unbound class method.</span>

<span class="sd">    This is used in practice to identify magic-named _name_changed</span>
<span class="sd">    and _name_fired methods.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># The ismethoddescriptor check catches methods written in C or Cython</span>
    <span class="c1"># extensions. It excludes things that pass an isfunction check, so we have</span>
    <span class="c1"># to explicitly re-include that check.</span>
    <span class="k">return</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isfunction</span><span class="p">(</span><span class="n">method</span><span class="p">)</span> <span class="ow">or</span> <span class="n">inspect</span><span class="o">.</span><span class="n">ismethoddescriptor</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_is_serializable</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns whether or not a specified value is serializable.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">_is_serializable</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">_is_serializable</span><span class="p">(</span><span class="n">name</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">_is_serializable</span><span class="p">(</span><span class="n">item</span><span class="p">)):</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">HasTraits</span><span class="p">))</span> <span class="ow">or</span> <span class="n">value</span><span class="o">.</span><span class="n">has_traits_interface</span><span class="p">(</span>
        <span class="n">ISerializable</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">_get_instance_handlers</span><span class="p">(</span><span class="n">class_dict</span><span class="p">,</span> <span class="n">bases</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns a dictionary of potential &#39;Instance&#39; or &#39;List(Instance)&#39;</span>
<span class="sd">        handlers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create the results dictionary:</span>
    <span class="n">instance_traits</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Merge all of the base class information into the result:</span>
    <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="n">bases</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">base_arg_lists</span> <span class="ow">in</span> <span class="n">base</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">InstanceTraits</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">arg_lists</span> <span class="o">=</span> <span class="n">instance_traits</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">arg_lists</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">instance_traits</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_arg_lists</span><span class="p">[:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">arg_list</span> <span class="ow">in</span> <span class="n">base_arg_lists</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">arg_list</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">arg_lists</span><span class="p">:</span>
                        <span class="n">arg_lists</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg_list</span><span class="p">)</span>

    <span class="c1"># Merge in the information from the class dictionary:</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">class_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">is_unbound_method_type</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="n">n</span> <span class="o">=</span> <span class="mi">13</span>
            <span class="n">col</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;_changed_for_&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">col</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="mi">11</span>
                <span class="n">col</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;_fired_for_&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">col</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">name</span><span class="p">[</span><span class="n">col</span> <span class="o">+</span> <span class="n">n</span><span class="p">:]</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                    <span class="n">arg_list</span> <span class="o">=</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">col</span><span class="p">])</span>
                    <span class="n">arg_lists</span> <span class="o">=</span> <span class="n">instance_traits</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">[])</span>
                    <span class="k">if</span> <span class="n">arg_list</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">arg_lists</span><span class="p">:</span>
                        <span class="n">arg_lists</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg_list</span><span class="p">)</span>

    <span class="c1"># Return the dictionary of possible arg_lists:</span>
    <span class="k">return</span> <span class="n">instance_traits</span>


<span class="k">def</span> <span class="nf">get_delegate_pattern</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">trait</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns the correct &#39;delegate&#39; listener pattern for a specified name</span>
<span class="sd">    and delegate trait.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="n">trait</span><span class="o">.</span><span class="n">_prefix</span>
    <span class="k">if</span> <span class="n">prefix</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">name</span>
    <span class="k">elif</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">prefix</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;*&quot;</span><span class="p">):</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">prefix</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">name</span>

    <span class="k">return</span> <span class="s2">&quot; </span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">trait</span><span class="o">.</span><span class="n">_delegate</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_SimpleTest</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">test</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>


<span class="k">def</span> <span class="nf">_add_notifiers</span><span class="p">(</span><span class="n">notifiers</span><span class="p">,</span> <span class="n">handlers</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Adds a list of handlers to a specified notifiers list.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="n">handlers</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="n">WrapperTypes</span><span class="p">):</span>
            <span class="n">handler</span> <span class="o">=</span> <span class="n">StaticTraitChangeNotifyWrapper</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
        <span class="n">notifiers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_add_event_handlers</span><span class="p">(</span><span class="n">trait</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">handlers</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Adds any specified event handlers defined for a trait by a class.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">events</span> <span class="o">=</span> <span class="n">trait</span><span class="o">.</span><span class="n">event</span>
    <span class="k">if</span> <span class="n">events</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">events</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">events</span> <span class="o">=</span> <span class="p">[</span><span class="n">events</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
            <span class="n">handlers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_get_method</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;_</span><span class="si">%s</span><span class="s2">_changed&quot;</span> <span class="o">%</span> <span class="n">event</span><span class="p">))</span>
            <span class="n">handlers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_get_method</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;_</span><span class="si">%s</span><span class="s2">_fired&quot;</span> <span class="o">%</span> <span class="n">event</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_property_method</span><span class="p">(</span><span class="n">class_dict</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns the method associated with a particular class property</span>
<span class="sd">    getter/setter.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">class_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_create_property_observe_state</span><span class="p">(</span><span class="n">observe</span><span class="p">,</span> <span class="n">property_name</span><span class="p">,</span> <span class="n">cached</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Create the metadata for setting up an observer for Property.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    observe : str or list or Expression</span>
<span class="sd">        As is accepted by HasTraits.observe expression argument</span>
<span class="sd">        This is the value provided in Property(observe=...)</span>
<span class="sd">    property_name : str</span>
<span class="sd">        The name of the property trait.</span>
<span class="sd">    cached : boolean</span>
<span class="sd">        Whether the property is cached or not.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    state : dict</span>
<span class="sd">        State to be used by _init_traits_observers</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">handler</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">cached</span><span class="p">:</span>
            <span class="n">cache_name</span> <span class="o">=</span> <span class="n">TraitsCache</span> <span class="o">+</span> <span class="n">property_name</span>
            <span class="n">old</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">cache_name</span><span class="p">,</span> <span class="n">Undefined</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">old</span> <span class="o">=</span> <span class="n">Undefined</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">trait_property_changed</span><span class="p">(</span><span class="n">property_name</span><span class="p">,</span> <span class="n">old</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">handler_getter</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="n">instance</span><span class="p">)</span>

    <span class="n">graphs</span> <span class="o">=</span> <span class="n">_compile_expression</span><span class="p">(</span><span class="n">observe</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">graphs</span><span class="o">=</span><span class="n">graphs</span><span class="p">,</span>
        <span class="n">dispatch</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">,</span>
        <span class="n">handler_getter</span><span class="o">=</span><span class="n">handler_getter</span><span class="p">,</span>
        <span class="n">post_init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">_compile_expression</span><span class="p">(</span><span class="n">expression</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Compile a user-supplied expression or list of expressions.</span>

<span class="sd">    Converts a list of strings or ObserverExpressions to a list of</span>
<span class="sd">    ObserverGraphs representing the observation patterns to be applied.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    expression : str or list or ObserverExpression</span>
<span class="sd">        A description of what traits are being observed.</span>
<span class="sd">        If this is a list, each item must be a string or an ObserverExpression.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    graphs : list of ObserverGraph</span>
<span class="sd">        List of graphs representing the observation patterns to be applied</span>
<span class="sd">        to the relevant objects and handlers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Handle the overloaded signature.</span>
    <span class="c1"># Support list to be consistent with on_trait_change.</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">expressions</span> <span class="o">=</span> <span class="n">expression</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">expressions</span> <span class="o">=</span> <span class="p">[</span><span class="n">expression</span><span class="p">]</span>

    <span class="n">graphs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">expr</span> <span class="ow">in</span> <span class="n">expressions</span><span class="p">:</span>
        <span class="n">graphs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
            <span class="n">observe_api</span><span class="o">.</span><span class="n">compile_str</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
            <span class="k">else</span> <span class="n">observe_api</span><span class="o">.</span><span class="n">compile_expr</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">graphs</span>


<span class="c1"># This really should be &#39;HasTraits&#39;, but it&#39;s not defined yet:</span>
<span class="n">_HasTraits</span> <span class="o">=</span> <span class="kc">None</span>


<span class="k">class</span> <span class="nc">MetaHasTraits</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Controls the creation of HasTraits classes.</span>

<span class="sd">    The heavy work is done by the `update_traits_class_dict` function, which</span>
<span class="sd">    takes the ``class_dict`` dictionary of class members and extracts and</span>
<span class="sd">    processes the trait declarations in it. The trait declarations are then</span>
<span class="sd">    added back to the class dictionary and passed off to the __new__ method</span>
<span class="sd">    of the type superclass, to be added to the class.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># All registered class creation listeners.</span>
    <span class="c1">#</span>
    <span class="c1"># { Str class_name : Callable listener }</span>
    <span class="n">_listeners</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">class_name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">class_dict</span><span class="p">):</span>
        <span class="n">update_traits_class_dict</span><span class="p">(</span><span class="n">class_name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">class_dict</span><span class="p">)</span>

        <span class="c1"># Finish building the class using the updated class dictionary:</span>
        <span class="n">klass</span> <span class="o">=</span> <span class="nb">type</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">class_name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">class_dict</span><span class="p">)</span>

        <span class="c1"># Call all listeners that registered for this specific class:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">klass</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span> <span class="n">klass</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">listener</span> <span class="ow">in</span> <span class="n">MetaHasTraits</span><span class="o">.</span><span class="n">_listeners</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">listener</span><span class="p">(</span><span class="n">klass</span><span class="p">)</span>

        <span class="c1"># Call all listeners that registered for ANY class:</span>
        <span class="k">for</span> <span class="n">listener</span> <span class="ow">in</span> <span class="n">MetaHasTraits</span><span class="o">.</span><span class="n">_listeners</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">listener</span><span class="p">(</span><span class="n">klass</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">klass</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">add_listener</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">listener</span><span class="p">,</span> <span class="n">class_name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Adds a class creation listener.</span>

<span class="sd">        If the class name is the empty string then the listener will be called</span>
<span class="sd">        when *any* class is created.</span>

<span class="sd">        .. deprecated:: 6.3.0</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;add_listener is deprecated&quot;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span>
        <span class="p">)</span>

        <span class="n">MetaHasTraits</span><span class="o">.</span><span class="n">_listeners</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">class_name</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">listener</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">remove_listener</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">listener</span><span class="p">,</span> <span class="n">class_name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Removes a class creation listener.</span>

<span class="sd">        .. deprecated:: 6.3.0</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;remove_listener is deprecated&quot;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span>
        <span class="p">)</span>

        <span class="n">MetaHasTraits</span><span class="o">.</span><span class="n">_listeners</span><span class="p">[</span><span class="n">class_name</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">listener</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">update_traits_class_dict</span><span class="p">(</span><span class="n">class_name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">class_dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Processes all of the traits related data in the class dictionary.</span>

<span class="sd">    This is called during the construction of a new HasTraits class. The first</span>
<span class="sd">    three parameters have the same interpretation as the corresponding</span>
<span class="sd">    parameters of ``type.__new__``. This function modifies ``class_dict``</span>
<span class="sd">    in-place.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    class_name : str</span>
<span class="sd">        The name of the HasTraits class.</span>
<span class="sd">    bases : tuple</span>
<span class="sd">        The base classes for the HasTraits class.</span>
<span class="sd">    class_dict : dict</span>
<span class="sd">        A dictionary of class members.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Create the various class dictionaries, lists and objects needed to</span>
    <span class="c1"># hold trait and view information and definitions:</span>
    <span class="n">base_traits</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">class_traits</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">prefix_traits</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">listeners</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">prefix_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">view_elements</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Mapping from method/trait names to list(dict)</span>
    <span class="c1"># where each nested dict provides the input arguments for calling</span>
    <span class="c1"># ``HasTraits.observe`` once. See ``_init_trait_observers``.`</span>
    <span class="n">observers</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Create a list of just those base classes that derive from HasTraits:</span>
    <span class="n">hastraits_bases</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">base</span> <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="n">bases</span> <span class="k">if</span> <span class="n">base</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ClassTraits</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="p">]</span>

    <span class="c1"># Create a list of all inherited trait dictionaries:</span>
    <span class="n">inherited_class_traits</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">base</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ClassTraits</span><span class="p">)</span> <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="n">hastraits_bases</span>
    <span class="p">]</span>

    <span class="c1"># Move all trait definitions from the class dictionary to the</span>
    <span class="c1"># appropriate trait class dictionaries:</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">class_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>

        <span class="n">value</span> <span class="o">=</span> <span class="n">check_trait</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">CTrait</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">rc</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">ForwardProperty</span><span class="p">):</span>
            <span class="n">rc</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># Create Property trait from getter, setter, validator</span>
            <span class="n">getter</span> <span class="o">=</span> <span class="n">_property_method</span><span class="p">(</span><span class="n">class_dict</span><span class="p">,</span> <span class="s2">&quot;_get_&quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">setter</span> <span class="o">=</span> <span class="n">_property_method</span><span class="p">(</span><span class="n">class_dict</span><span class="p">,</span> <span class="s2">&quot;_set_&quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">setter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">getter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">getter</span><span class="p">,</span> <span class="s2">&quot;settable&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                    <span class="n">setter</span> <span class="o">=</span> <span class="n">HasTraits</span><span class="o">.</span><span class="n">_set_traits_cache</span>
                <span class="k">elif</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">getter</span><span class="p">,</span> <span class="s2">&quot;flushable&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                    <span class="n">setter</span> <span class="o">=</span> <span class="n">HasTraits</span><span class="o">.</span><span class="n">_flush_traits_cache</span>
            <span class="n">validate</span> <span class="o">=</span> <span class="n">_property_method</span><span class="p">(</span><span class="n">class_dict</span><span class="p">,</span> <span class="s2">&quot;_validate_&quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">validate</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">validate</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">validate</span>

            <span class="n">value</span> <span class="o">=</span> <span class="n">Property</span><span class="p">(</span>
                <span class="n">getter</span><span class="p">,</span> <span class="n">setter</span><span class="p">,</span> <span class="n">validate</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">value</span><span class="o">.</span><span class="n">handler</span><span class="p">,</span> <span class="o">**</span><span class="n">value</span><span class="o">.</span><span class="n">metadata</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">rc</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">class_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">name</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="o">!=</span> <span class="s2">&quot;_&quot;</span><span class="p">:</span>
                <span class="n">base_traits</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">class_traits</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="n">value_type</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">type</span>
                <span class="k">if</span> <span class="n">value_type</span> <span class="o">==</span> <span class="s2">&quot;trait&quot;</span><span class="p">:</span>
                    <span class="n">handler</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">handler</span>
                    <span class="k">if</span> <span class="n">handler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">handler</span><span class="o">.</span><span class="n">has_items</span><span class="p">:</span>
                            <span class="n">items_trait</span> <span class="o">=</span> <span class="n">_clone_trait</span><span class="p">(</span>
                                <span class="n">handler</span><span class="o">.</span><span class="n">items_event</span><span class="p">(),</span> <span class="n">value</span><span class="o">.</span><span class="vm">__dict__</span>
                            <span class="p">)</span>

                            <span class="k">if</span> <span class="p">(</span>
                                <span class="n">items_trait</span><span class="o">.</span><span class="n">instance_handler</span>
                                <span class="o">==</span> <span class="s2">&quot;_list_changed_handler&quot;</span>
                            <span class="p">):</span>
                                <span class="n">items_trait</span><span class="o">.</span><span class="n">instance_handler</span> <span class="o">=</span> <span class="p">(</span>
                                    <span class="s2">&quot;_list_items_changed_handler&quot;</span>
                                <span class="p">)</span>

                            <span class="n">class_traits</span><span class="p">[</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_items&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">items_trait</span>

                        <span class="k">if</span> <span class="n">handler</span><span class="o">.</span><span class="n">is_mapped</span><span class="p">:</span>
                            <span class="n">class_traits</span><span class="p">[</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_trait_for</span><span class="p">(</span>
                                <span class="n">value</span><span class="p">,</span> <span class="n">name</span>
                            <span class="p">)</span>

                <span class="k">elif</span> <span class="n">value_type</span> <span class="o">==</span> <span class="s2">&quot;delegate&quot;</span><span class="p">:</span>
                    <span class="c1"># Only add a listener if the trait.listenable metadata</span>
                    <span class="c1"># is not False:</span>
                    <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">_listenable</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="n">listeners</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="s2">&quot;delegate&quot;</span><span class="p">,</span>
                            <span class="n">get_delegate_pattern</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">),</span>
                        <span class="p">)</span>
                <span class="k">elif</span> <span class="n">value_type</span> <span class="o">==</span> <span class="s2">&quot;event&quot;</span><span class="p">:</span>
                    <span class="n">on_trait_change</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">on_trait_change</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">on_trait_change</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="n">listeners</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;event&quot;</span><span class="p">,</span> <span class="n">on_trait_change</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">prefix_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="n">prefix_traits</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">elif</span> <span class="n">is_unbound_method_type</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s2">&quot;on_trait_change&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pattern</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">listeners</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;method&quot;</span><span class="p">,</span> <span class="n">pattern</span><span class="p">)</span>

            <span class="n">observer_states</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s2">&quot;_observe_inputs&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">observer_states</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">observers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">observer_states</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">property</span><span class="p">):</span>
            <span class="n">class_traits</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">generic_trait</span>

        <span class="c1"># Handle any view elements found in the class:</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">AbstractViewElement</span><span class="p">):</span>

            <span class="n">view_elements</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

            <span class="c1"># Remove the view element from the class definition:</span>
            <span class="k">del</span> <span class="n">class_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ct</span> <span class="ow">in</span> <span class="n">inherited_class_traits</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">ct</span><span class="p">:</span>
                    <span class="c1"># The subclass is providing a default value for the</span>
                    <span class="c1"># trait defined in a superclass.</span>
                    <span class="n">ictrait</span> <span class="o">=</span> <span class="n">ct</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">ictrait</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="n">CantHaveDefaultValue</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">TraitError</span><span class="p">(</span>
                            <span class="s2">&quot;Cannot specify a default value &quot;</span>
                            <span class="s2">&quot;for the </span><span class="si">%s</span><span class="s2"> trait &#39;</span><span class="si">%s</span><span class="s2">&#39;. You must override the &quot;</span>
                            <span class="s2">&quot;the trait definition instead.&quot;</span>
                            <span class="o">%</span> <span class="p">(</span><span class="n">ictrait</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                        <span class="p">)</span>

                    <span class="n">default_value</span> <span class="o">=</span> <span class="n">value</span>
                    <span class="n">class_traits</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span> <span class="o">=</span> <span class="n">ictrait</span><span class="p">(</span><span class="n">default_value</span><span class="p">)</span>
                    <span class="c1"># Make sure that the trait now has the default value</span>
                    <span class="c1"># has the correct initializer.</span>
                    <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">setattr_original_value</span><span class="p">:</span>
                        <span class="c1"># Set the original, non validated value</span>
                        <span class="n">value</span><span class="o">.</span><span class="n">set_default_value</span><span class="p">(</span>
                            <span class="n">DefaultValue</span><span class="o">.</span><span class="n">missing</span><span class="p">,</span> <span class="n">default_value</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">value</span><span class="o">.</span><span class="n">set_default_value</span><span class="p">(</span>
                            <span class="n">DefaultValue</span><span class="o">.</span><span class="n">missing</span><span class="p">,</span> <span class="n">value</span><span class="o">.</span><span class="n">default</span><span class="p">)</span>
                    <span class="k">del</span> <span class="n">class_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                    <span class="k">break</span>

    <span class="c1"># Process all HasTraits base classes:</span>
    <span class="n">migrated_properties</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="n">hastraits_bases</span><span class="p">:</span>
        <span class="n">base_dict</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="vm">__dict__</span>

        <span class="c1"># Merge listener information:</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">base_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ListenerTraits</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">class_traits</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">class_dict</span><span class="p">):</span>
                <span class="n">listeners</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="c1"># Merge observer information:</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">states</span> <span class="ow">in</span> <span class="n">base_dict</span><span class="p">[</span><span class="n">ObserverTraits</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">class_traits</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">class_dict</span><span class="p">):</span>
                <span class="n">observers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">states</span>

        <span class="c1"># Merge base traits:</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">base_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">BaseTraits</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">base_traits</span><span class="p">:</span>
                <span class="n">property_info</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">property_fields</span>
                <span class="k">if</span> <span class="n">property_info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="nb">id</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="n">migrated_properties</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span> <span class="o">=</span> <span class="n">migrate_property</span><span class="p">(</span>
                        <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">property_info</span><span class="p">,</span> <span class="n">class_dict</span>
                    <span class="p">)</span>
                <span class="n">base_traits</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="c1"># Merge class traits:</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">base_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ClassTraits</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">class_traits</span><span class="p">:</span>
                <span class="n">property_info</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">property_fields</span>
                <span class="k">if</span> <span class="n">property_info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">new_value</span> <span class="o">=</span> <span class="n">migrated_properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">new_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">new_value</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">migrate_property</span><span class="p">(</span>
                            <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">property_info</span><span class="p">,</span> <span class="n">class_dict</span>
                        <span class="p">)</span>
                <span class="n">class_traits</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="c1"># Merge prefix traits:</span>
        <span class="n">base_prefix_traits</span> <span class="o">=</span> <span class="n">base_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">PrefixTraits</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">base_prefix_traits</span><span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">prefix_list</span><span class="p">:</span>
                <span class="n">prefix_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="n">prefix_traits</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_prefix_traits</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

    <span class="c1"># Make sure there is a definition for &#39;undefined&#39; traits:</span>
    <span class="k">if</span> <span class="n">prefix_traits</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">prefix_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">prefix_traits</span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Python</span><span class="p">()</span><span class="o">.</span><span class="n">as_ctrait</span><span class="p">()</span>

    <span class="c1"># Save a link to the prefix_list:</span>
    <span class="n">prefix_traits</span><span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prefix_list</span>

    <span class="c1"># Make sure the trait prefixes are sorted longest to shortest</span>
    <span class="c1"># so that we can easily bind dynamic traits to the longest matching</span>
    <span class="c1"># prefix:</span>
    <span class="n">prefix_list</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="nb">len</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Get the list of all possible &#39;Instance&#39;/&#39;List(Instance)&#39; handlers:</span>
    <span class="n">instance_traits</span> <span class="o">=</span> <span class="n">_get_instance_handlers</span><span class="p">(</span><span class="n">class_dict</span><span class="p">,</span> <span class="n">hastraits_bases</span><span class="p">)</span>

    <span class="c1"># If there is an &#39;anytrait_changed&#39; event handler, wrap it so that</span>
    <span class="c1"># it can be attached to all traits in the class:</span>
    <span class="n">anytrait</span> <span class="o">=</span> <span class="n">_get_def</span><span class="p">(</span><span class="n">class_name</span><span class="p">,</span> <span class="n">class_dict</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="s2">&quot;_anytrait_changed&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">anytrait</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">anytrait</span> <span class="o">=</span> <span class="n">StaticAnytraitChangeNotifyWrapper</span><span class="p">(</span><span class="n">anytrait</span><span class="p">)</span>

        <span class="c1"># Save it in the prefix traits dictionary so that any dynamically</span>
        <span class="c1"># created traits (e.g. &#39;prefix traits&#39;) can re-use it:</span>
        <span class="n">prefix_traits</span><span class="p">[</span><span class="s2">&quot;@&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">anytrait</span>

    <span class="c1"># Make one final pass over the class traits dictionary, making sure</span>
    <span class="c1"># all static trait notification handlers are attached to a &#39;cloned&#39;</span>
    <span class="c1"># copy of the original trait:</span>
    <span class="n">cloned</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">class_traits</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">trait</span> <span class="o">=</span> <span class="n">class_traits</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="n">handlers</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">anytrait</span><span class="p">,</span>
            <span class="n">_get_def</span><span class="p">(</span><span class="n">class_name</span><span class="p">,</span> <span class="n">class_dict</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="s2">&quot;_</span><span class="si">%s</span><span class="s2">_changed&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">),</span>
            <span class="n">_get_def</span><span class="p">(</span><span class="n">class_name</span><span class="p">,</span> <span class="n">class_dict</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="s2">&quot;_</span><span class="si">%s</span><span class="s2">_fired&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">),</span>
        <span class="p">]</span>

        <span class="c1"># Check for an &#39;Instance&#39; or &#39;List(Instance)&#39; trait with defined</span>
        <span class="c1"># handlers:</span>
        <span class="n">instance_handler</span> <span class="o">=</span> <span class="n">trait</span><span class="o">.</span><span class="n">instance_handler</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">instance_handler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
            <span class="ow">and</span> <span class="p">(</span><span class="n">name</span> <span class="ow">in</span> <span class="n">instance_traits</span><span class="p">)</span>
            <span class="ow">or</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">instance_handler</span> <span class="o">==</span> <span class="s2">&quot;_list_items_changed_handler&quot;</span><span class="p">)</span>
                <span class="ow">and</span> <span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="o">-</span><span class="mi">6</span><span class="p">:]</span> <span class="o">==</span> <span class="s2">&quot;_items&quot;</span><span class="p">)</span>
                <span class="ow">and</span> <span class="p">(</span><span class="n">name</span><span class="p">[:</span><span class="o">-</span><span class="mi">6</span><span class="p">]</span> <span class="ow">in</span> <span class="n">instance_traits</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">):</span>
            <span class="n">handlers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">HasTraits</span><span class="p">,</span> <span class="n">instance_handler</span><span class="p">))</span>

        <span class="n">events</span> <span class="o">=</span> <span class="n">trait</span><span class="o">.</span><span class="n">event</span>
        <span class="k">if</span> <span class="n">events</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">events</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">events</span> <span class="o">=</span> <span class="p">[</span><span class="n">events</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
                <span class="n">handlers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">_get_def</span><span class="p">(</span>
                        <span class="n">class_name</span><span class="p">,</span> <span class="n">class_dict</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="s2">&quot;_</span><span class="si">%s</span><span class="s2">_changed&quot;</span> <span class="o">%</span> <span class="n">event</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="n">handlers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">_get_def</span><span class="p">(</span>
                        <span class="n">class_name</span><span class="p">,</span> <span class="n">class_dict</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="s2">&quot;_</span><span class="si">%s</span><span class="s2">_fired&quot;</span> <span class="o">%</span> <span class="n">event</span>
                    <span class="p">)</span>
                <span class="p">)</span>

        <span class="n">handlers</span> <span class="o">=</span> <span class="p">[</span><span class="n">h</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">handlers</span> <span class="k">if</span> <span class="n">h</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">default</span> <span class="o">=</span> <span class="n">_get_def</span><span class="p">(</span><span class="n">class_name</span><span class="p">,</span> <span class="n">class_dict</span><span class="p">,</span> <span class="p">[],</span> <span class="s2">&quot;_</span><span class="si">%s</span><span class="s2">_default&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">handlers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>

            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cloned</span><span class="p">:</span>
                <span class="n">cloned</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="n">class_traits</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">trait</span> <span class="o">=</span> <span class="n">_clone_trait</span><span class="p">(</span><span class="n">trait</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">handlers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">_add_notifiers</span><span class="p">(</span><span class="n">trait</span><span class="o">.</span><span class="n">_notifiers</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span> <span class="n">handlers</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">trait</span><span class="o">.</span><span class="n">set_default_value</span><span class="p">(</span><span class="n">DefaultValue</span><span class="o">.</span><span class="n">callable</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>

        <span class="c1"># Handle the case of properties whose value depends upon the value</span>
        <span class="c1"># of other traits:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">trait</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;property&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">trait</span><span class="o">.</span><span class="n">depends_on</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>

            <span class="n">cached</span> <span class="o">=</span> <span class="n">trait</span><span class="o">.</span><span class="n">cached</span>
            <span class="k">if</span> <span class="n">cached</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">cached</span> <span class="o">=</span> <span class="n">TraitsCache</span> <span class="o">+</span> <span class="n">name</span>

            <span class="n">depends_on</span> <span class="o">=</span> <span class="n">trait</span><span class="o">.</span><span class="n">depends_on</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">depends_on</span><span class="p">,</span> <span class="n">SequenceTypes</span><span class="p">):</span>
                <span class="n">depends_on</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">depends_on</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Note: We add the leading blank to force it to be treated</span>
                <span class="c1"># as using the extended trait notation so that it will</span>
                <span class="c1"># automatically add &#39;_items&#39; listeners to lists/dicts:</span>
                <span class="n">depends_on</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">depends_on</span>

            <span class="n">listeners</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;property&quot;</span><span class="p">,</span> <span class="n">cached</span><span class="p">,</span> <span class="n">depends_on</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">trait</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;property&quot;</span> <span class="ow">and</span> <span class="n">trait</span><span class="o">.</span><span class="n">observe</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">observer_state</span> <span class="o">=</span> <span class="n">_create_property_observe_state</span><span class="p">(</span>
                <span class="n">observe</span><span class="o">=</span><span class="n">trait</span><span class="o">.</span><span class="n">observe</span><span class="p">,</span>
                <span class="n">property_name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                <span class="n">cached</span><span class="o">=</span><span class="n">trait</span><span class="o">.</span><span class="n">cached</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">observers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">observer_state</span><span class="p">]</span>

    <span class="c1"># Add processed traits back into class_dict.</span>
    <span class="n">class_dict</span><span class="p">[</span><span class="n">BaseTraits</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_traits</span>
    <span class="n">class_dict</span><span class="p">[</span><span class="n">ClassTraits</span><span class="p">]</span> <span class="o">=</span> <span class="n">class_traits</span>
    <span class="n">class_dict</span><span class="p">[</span><span class="n">InstanceTraits</span><span class="p">]</span> <span class="o">=</span> <span class="n">instance_traits</span>
    <span class="n">class_dict</span><span class="p">[</span><span class="n">PrefixTraits</span><span class="p">]</span> <span class="o">=</span> <span class="n">prefix_traits</span>
    <span class="n">class_dict</span><span class="p">[</span><span class="n">ListenerTraits</span><span class="p">]</span> <span class="o">=</span> <span class="n">listeners</span>
    <span class="n">class_dict</span><span class="p">[</span><span class="n">ObserverTraits</span><span class="p">]</span> <span class="o">=</span> <span class="n">observers</span>
    <span class="n">class_dict</span><span class="p">[</span><span class="n">ViewTraits</span><span class="p">]</span> <span class="o">=</span> <span class="n">view_elements</span>


<span class="k">def</span> <span class="nf">migrate_property</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">property</span><span class="p">,</span> <span class="n">property_info</span><span class="p">,</span> <span class="n">class_dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Migrates an existing property to the class being defined</span>
<span class="sd">    (allowing for method overrides).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">get</span> <span class="o">=</span> <span class="n">_property_method</span><span class="p">(</span><span class="n">class_dict</span><span class="p">,</span> <span class="s2">&quot;_get_&quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
    <span class="nb">set</span> <span class="o">=</span> <span class="n">_property_method</span><span class="p">(</span><span class="n">class_dict</span><span class="p">,</span> <span class="s2">&quot;_set_&quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">_property_method</span><span class="p">(</span><span class="n">class_dict</span><span class="p">,</span> <span class="s2">&quot;_validate_&quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">get</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">set</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">old_get</span><span class="p">,</span> <span class="n">old_set</span><span class="p">,</span> <span class="n">old_val</span> <span class="o">=</span> <span class="n">property_info</span>
        <span class="k">return</span> <span class="n">Property</span><span class="p">(</span>
            <span class="n">get</span> <span class="ow">or</span> <span class="n">old_get</span><span class="p">,</span>
            <span class="nb">set</span> <span class="ow">or</span> <span class="n">old_set</span><span class="p">,</span>
            <span class="n">val</span> <span class="ow">or</span> <span class="n">old_val</span><span class="p">,</span>
            <span class="kc">True</span><span class="p">,</span>
            <span class="o">**</span><span class="nb">property</span><span class="o">.</span><span class="vm">__dict__</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="nb">property</span>


<span class="c1"># &#39;HasTraits&#39; decorators</span>

<span class="k">def</span> <span class="nf">observe</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">post_init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dispatch</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Marks the wrapped method as being a handler to be called when the</span>
<span class="sd">    specified traits change.</span>

<span class="sd">    This decorator can be stacked, e.g.::</span>

<span class="sd">        @observe(&quot;attr1&quot;)</span>
<span class="sd">        @observe(&quot;attr2&quot;, post_init=True)</span>
<span class="sd">        def updated(self, event):</span>
<span class="sd">            ...</span>

<span class="sd">    The decorated function must accept one argument which is the event object</span>
<span class="sd">    representing the change. See :mod:`traits.observation.events` for details.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    expression : str or list or ObserverExpression</span>
<span class="sd">        A description of what traits are being observed.</span>
<span class="sd">        If this is a list, each item must be a string or Expression.</span>
<span class="sd">        See :py:func:`HasTraits.observe` for details on the</span>
<span class="sd">        semantics when passing a string.</span>
<span class="sd">    post_init : boolean, optional</span>
<span class="sd">        Whether the change handler should be attached after</span>
<span class="sd">        the state is set when instantiating an object. Default is false, and</span>
<span class="sd">        values provided to the instance constructor will trigger the</span>
<span class="sd">        change handler to fire if the value is different from the</span>
<span class="sd">        default. Set to true to avoid this change event.</span>
<span class="sd">    dispatch : str, optional</span>
<span class="sd">        A string indicating how the handler should be run. Default is to run</span>
<span class="sd">        it on the same thread where the change occurs.</span>
<span class="sd">        Possible values are:</span>

<span class="sd">        =========== =======================================================</span>
<span class="sd">        value       dispatch</span>
<span class="sd">        =========== =======================================================</span>
<span class="sd">        ``same``    Run notifications on the same thread where the change</span>
<span class="sd">                    occurs. The notifications are executed immediately.</span>
<span class="sd">        ``ui``      Run notifications on the UI thread. If the current</span>
<span class="sd">                    thread is the UI thread, the notifications are executed</span>
<span class="sd">                    immediately; otherwise, they are placed on the UI</span>
<span class="sd">                    event queue.</span>
<span class="sd">        =========== =======================================================</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    HasTraits.observe</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">graphs</span> <span class="o">=</span> <span class="n">_compile_expression</span><span class="p">(</span><span class="n">expression</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">observe_decorator</span><span class="p">(</span><span class="n">handler</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Create input arguments for HasTraits.observe and attach the input</span>
<span class="sd">        to the callable.</span>

<span class="sd">        The metaclass will then collect this information for calling</span>
<span class="sd">        HasTraits.observe with the decorated function.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        handler : callable</span>
<span class="sd">            Method of a subclass of HasTraits, with signature of the form</span>
<span class="sd">            ``my_method(self, event)``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Warn on a dubious handler signature. The handler should accept a call</span>
        <span class="c1"># that passes a single positional argument (conventionally named</span>
        <span class="c1"># &quot;event&quot;) in addition to the usual &quot;self&quot;.</span>
        <span class="n">handler_signature</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">handler_signature</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;self&quot;</span><span class="p">,</span> <span class="s2">&quot;event&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="s2">&quot;Dubious signature for observe-decorated method. &quot;</span>
                    <span class="s2">&quot;The decorated method should be callable with a &quot;</span>
                    <span class="s2">&quot;single positional argument in addition to &#39;self&#39;. &quot;</span>
                    <span class="s2">&quot;Did you forget to add an &#39;event&#39; parameter?&quot;</span>
                <span class="p">),</span>
                <span class="ne">UserWarning</span><span class="p">,</span>
                <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">observe_inputs</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">_observe_inputs</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">observe_inputs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">handler</span><span class="o">.</span><span class="n">_observe_inputs</span> <span class="o">=</span> <span class="n">observe_inputs</span>

        <span class="n">observe_input</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">graphs</span><span class="o">=</span><span class="n">graphs</span><span class="p">,</span>
            <span class="n">dispatch</span><span class="o">=</span><span class="n">dispatch</span><span class="p">,</span>
            <span class="n">post_init</span><span class="o">=</span><span class="n">post_init</span><span class="p">,</span>
            <span class="n">handler_getter</span><span class="o">=</span><span class="nb">getattr</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">observe_inputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">observe_input</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">handler</span>
    <span class="k">return</span> <span class="n">observe_decorator</span>


<span class="k">def</span> <span class="nf">on_trait_change</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">post_init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dispatch</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Marks the following method definition as being a handler for the</span>
<span class="sd">        extended trait change specified by *name(s)*.</span>

<span class="sd">        Refer to the documentation for the on_trait_change() method of</span>
<span class="sd">        the **HasTraits** class for information on the correct syntax for</span>
<span class="sd">        the *name* argument and the semantics of the *dispatch* keyword</span>
<span class="sd">        argument.</span>

<span class="sd">        A handler defined using this decorator is normally effective</span>
<span class="sd">        immediately. However, if *post_init* is **True**, then the handler only</span>
<span class="sd">        becomes effective after all object constructor arguments have been</span>
<span class="sd">        processed. That is, trait values assigned as part of object</span>
<span class="sd">        construction will not cause the handler to be invoked.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        observe : A newer API for defining traits notifications.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">function</span><span class="p">):</span>

        <span class="n">function</span><span class="o">.</span><span class="n">on_trait_change</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;pattern&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
            <span class="s2">&quot;post_init&quot;</span><span class="p">:</span> <span class="n">post_init</span><span class="p">,</span>
            <span class="s2">&quot;dispatch&quot;</span><span class="p">:</span> <span class="n">dispatch</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">function</span>

    <span class="k">return</span> <span class="n">decorator</span>


<span class="k">def</span> <span class="nf">cached_property</span><span class="p">(</span><span class="n">function</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Marks the following method definition as being a &quot;cached property&quot;.</span>
<span class="sd">        That is, it is a property getter which, for performance reasons, caches</span>
<span class="sd">        its most recently computed result in an attribute whose name is of the</span>
<span class="sd">        form: *_traits_cache_name*, where *name* is the name of the property. A</span>
<span class="sd">        method marked as being a cached property needs only to compute and</span>
<span class="sd">        return its result. The @cached_property decorator automatically wraps</span>
<span class="sd">        the decorated method in cache management code, eliminating the need to</span>
<span class="sd">        write boilerplate cache management code explicitly. For example::</span>

<span class="sd">            file_name = File</span>
<span class="sd">            file_contents = Property(observe=&#39;file_name&#39;)</span>

<span class="sd">            @cached_property</span>
<span class="sd">            def _get_file_contents(self):</span>
<span class="sd">                with open(self.file_name, &#39;rb&#39;) as fh:</span>
<span class="sd">                    return fh.read()</span>

<span class="sd">        In this example, accessing the *file_contents* trait calls the</span>
<span class="sd">        _get_file_contents() method only once each time after the **file_name**</span>
<span class="sd">        trait is modified. In all other cases, the cached value</span>
<span class="sd">        **_file_contents**, which maintained by the @cached_property wrapper</span>
<span class="sd">        code, is returned.</span>

<span class="sd">        Note the use, in the example, of the **observe** metadata attribute</span>
<span class="sd">        to specify that the value of **file_contents** depends on</span>
<span class="sd">        **file_name**, so that _get_file_contents() is called only when</span>
<span class="sd">        **file_name** changes. For details, see the traits.traits.Property()</span>
<span class="sd">        function.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">TraitsCache</span> <span class="o">+</span> <span class="n">function</span><span class="o">.</span><span class="vm">__name__</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span>

    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">Undefined</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="n">Undefined</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="n">decorator</span><span class="o">.</span><span class="n">cached_property</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="n">decorator</span>


<span class="k">def</span> <span class="nf">property_depends_on</span><span class="p">(</span><span class="n">dependency</span><span class="p">,</span> <span class="n">settable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">flushable</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Marks the following method definition as being a &quot;cached property&quot;</span>
<span class="sd">        that depends on the specified extended trait names. That is, it is a</span>
<span class="sd">        property getter which, for performance reasons, caches its most</span>
<span class="sd">        recently computed result in an attribute whose name is of the form:</span>
<span class="sd">        *_traits_cache_name*, where *name* is the name of the property. A</span>
<span class="sd">        method marked as being a cached property needs only to compute and</span>
<span class="sd">        return its result. The @property_depends_on decorator automatically</span>
<span class="sd">        wraps the decorated method in cache management code that will cache the</span>
<span class="sd">        most recently computed value and flush the cache when any of the</span>
<span class="sd">        specified dependencies are modified, thus eliminating the need to write</span>
<span class="sd">        boilerplate cache management code explicitly. For example::</span>

<span class="sd">            file_name = File</span>
<span class="sd">            file_contents = Property</span>

<span class="sd">            @property_depends_on( &#39;file_name&#39; )</span>
<span class="sd">            def _get_file_contents(self):</span>
<span class="sd">                with open(self.file_name, &#39;rb&#39;) as fh:</span>
<span class="sd">                    return fh.read()</span>

<span class="sd">        In this example, accessing the *file_contents* trait calls the</span>
<span class="sd">        _get_file_contents() method only once each time after the **file_name**</span>
<span class="sd">        trait is modified. In all other cases, the cached value</span>
<span class="sd">        **_file_contents**, which is maintained by the @cached_property wrapper</span>
<span class="sd">        code, is returned.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">function</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">TraitsCache</span> <span class="o">+</span> <span class="n">function</span><span class="o">.</span><span class="vm">__name__</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span>

        <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">Undefined</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="n">Undefined</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">result</span>

        <span class="n">wrapper</span><span class="o">.</span><span class="n">cached_property</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">wrapper</span><span class="o">.</span><span class="n">depends_on</span> <span class="o">=</span> <span class="n">dependency</span>
        <span class="n">wrapper</span><span class="o">.</span><span class="n">settable</span> <span class="o">=</span> <span class="n">settable</span>
        <span class="n">wrapper</span><span class="o">.</span><span class="n">flushable</span> <span class="o">=</span> <span class="n">flushable</span>

        <span class="k">return</span> <span class="n">wrapper</span>

    <span class="k">return</span> <span class="n">decorator</span>


<span class="k">def</span> <span class="nf">weak_arg</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Create a weak reference to arg and wrap the function so that the</span>
<span class="sd">    dereferenced weakref is passed as the first argument. If arg has been</span>
<span class="sd">    deleted then the function is not called.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create the weak reference</span>
    <span class="n">weak_arg</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">function</span><span class="p">):</span>
        <span class="c1"># We need multiple wrappers to traits can find the number of arguments.</span>
        <span class="c1"># The all just dereference the weak reference and the call the</span>
        <span class="c1"># function if it is not None.</span>
        <span class="k">def</span> <span class="nf">wrapper0</span><span class="p">():</span>
            <span class="n">arg</span> <span class="o">=</span> <span class="n">weak_arg</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">arg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">function</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">wrapper1</span><span class="p">(</span><span class="n">arg1</span><span class="p">):</span>
            <span class="n">arg</span> <span class="o">=</span> <span class="n">weak_arg</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">arg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">function</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">arg1</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">wrapper2</span><span class="p">(</span><span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">):</span>
            <span class="n">arg</span> <span class="o">=</span> <span class="n">weak_arg</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">arg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">function</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">wrapper3</span><span class="p">(</span><span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">,</span> <span class="n">arg3</span><span class="p">):</span>
            <span class="n">arg</span> <span class="o">=</span> <span class="n">weak_arg</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">arg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">function</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">,</span> <span class="n">arg3</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">wrapper4</span><span class="p">(</span><span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">,</span> <span class="n">arg3</span><span class="p">,</span> <span class="n">arg4</span><span class="p">):</span>
            <span class="n">arg</span> <span class="o">=</span> <span class="n">weak_arg</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">arg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">function</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">,</span> <span class="n">arg3</span><span class="p">,</span> <span class="n">arg4</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">wrappern</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
            <span class="n">arg</span> <span class="o">=</span> <span class="n">weak_arg</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">arg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">function</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>

        <span class="c1"># Return the correct wrapper depending on the arg count</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">function</span><span class="o">.</span><span class="vm">__code__</span><span class="o">.</span><span class="n">co_argcount</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">args</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">wrapper0</span>
        <span class="k">elif</span> <span class="n">args</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">wrapper1</span>
        <span class="k">elif</span> <span class="n">args</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">wrapper2</span>
        <span class="k">elif</span> <span class="n">args</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">wrapper3</span>
        <span class="k">elif</span> <span class="n">args</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">wrapper4</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">wrappern</span>

    <span class="k">return</span> <span class="n">decorator</span>


<span class="k">class</span> <span class="nc">HasTraits</span><span class="p">(</span><span class="n">CHasTraits</span><span class="p">,</span> <span class="n">metaclass</span><span class="o">=</span><span class="n">MetaHasTraits</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Enables any Python class derived from it to have trait attributes.</span>

<span class="sd">    Most of the methods of HasTraits operated by default only on the trait</span>
<span class="sd">    attributes explicitly defined in the class definition. They do not operate</span>
<span class="sd">    on trait attributes defined by way of wildcards or by calling</span>
<span class="sd">    **add_trait()**.</span>
<span class="sd">    For example::</span>

<span class="sd">        &gt;&gt;&gt; class Person(HasTraits):</span>
<span class="sd">        ...     name = Str</span>
<span class="sd">        ...     age  = Int</span>
<span class="sd">        ...     temp_ = Any</span>
<span class="sd">        &gt;&gt;&gt; bob = Person()</span>
<span class="sd">        &gt;&gt;&gt; bob.temp_lunch = &#39;sandwich&#39;</span>
<span class="sd">        &gt;&gt;&gt; bob.add_trait(&#39;favorite_sport&#39;, Str(&#39;football&#39;))</span>
<span class="sd">        &gt;&gt;&gt; print(bob.trait_names())</span>
<span class="sd">        [&#39;trait_added&#39;, &#39;age&#39;, &#39;name&#39;]</span>

<span class="sd">    In this example, the trait_names() method returns only the *age* and</span>
<span class="sd">    *name* attributes defined on the Person class. (The **trait_added**</span>
<span class="sd">    attribute is an explicit trait event defined on the HasTraits class.)</span>
<span class="sd">    The wildcard attribute *temp_lunch* and the dynamically-added trait</span>
<span class="sd">    attribute *favorite_sport* are not listed.</span>

<span class="sd">    Subclass should avoid defining new traits and/or methods with names</span>
<span class="sd">    starting with &quot;trait&quot; or &quot;_trait&quot; to avoid overshadowing existing methods,</span>
<span class="sd">    unless it has been documented as being safe to do so.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># -- Trait Prefix Rules ---------------------------------------------------</span>

    <span class="c1">#: Make traits &#39;property cache&#39; values private with no type checking:</span>
    <span class="n">_traits_cache__</span> <span class="o">=</span> <span class="n">Any</span><span class="p">(</span><span class="n">private</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">transient</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># -- Class Variables ------------------------------------------------------</span>

    <span class="c1">#: Mapping from dispatch type to notification wrapper class type</span>
    <span class="n">wrappers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;same&quot;</span><span class="p">:</span> <span class="n">TraitChangeNotifyWrapper</span><span class="p">,</span>
        <span class="s2">&quot;extended&quot;</span><span class="p">:</span> <span class="n">ExtendedTraitChangeNotifyWrapper</span><span class="p">,</span>
        <span class="s2">&quot;new&quot;</span><span class="p">:</span> <span class="n">NewTraitChangeNotifyWrapper</span><span class="p">,</span>
        <span class="s2">&quot;fast_ui&quot;</span><span class="p">:</span> <span class="n">FastUITraitChangeNotifyWrapper</span><span class="p">,</span>
        <span class="s2">&quot;ui&quot;</span><span class="p">:</span> <span class="n">FastUITraitChangeNotifyWrapper</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1"># -- Trait Definitions ----------------------------------------------------</span>

    <span class="c1">#: An event fired when a new trait is dynamically added to the object. The</span>
    <span class="c1">#: value is the name of the trait that was added.</span>
    <span class="n">trait_added</span> <span class="o">=</span> <span class="n">Event</span><span class="p">(</span><span class="n">Str</span><span class="p">())</span>

    <span class="c1">#: An event that can be fired to indicate that the state of the object has</span>
    <span class="c1">#: been modified.</span>
    <span class="n">trait_modified</span> <span class="o">=</span> <span class="n">Event</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_trait_added_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Handles a &#39;trait_added&#39; event being fired.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># fixme: This test should be made more comprehensive by also verifying</span>
        <span class="c1"># that if the trait name does end in &#39;_items&#39;, its base trait is also</span>
        <span class="c1"># a list or dictionary (in order to eliminate a false positive on an</span>
        <span class="c1"># unfortunately named trait:</span>
        <span class="n">trait</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trait</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">trait</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;delegate&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="o">-</span><span class="mi">6</span><span class="p">:]</span> <span class="o">!=</span> <span class="s2">&quot;_items&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_trait_delegate_listener</span><span class="p">(</span>
                <span class="n">name</span><span class="p">,</span> <span class="s2">&quot;delegate&quot;</span><span class="p">,</span> <span class="n">get_delegate_pattern</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">trait</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">add_class_trait</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">trait</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Adds a named trait attribute to this class.</span>

<span class="sd">        Also adds the same attribute to all subclasses.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            Name of the attribute to add.</span>
<span class="sd">        *trait :</span>
<span class="sd">            A trait or a value that can be converted to a trait using Trait()</span>
<span class="sd">            Trait definition of the attribute. It can be a single value or</span>
<span class="sd">            a list equivalent to an argument list for the Trait() function.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Make sure a trait argument was specified:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">trait</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No trait definition was specified.&quot;</span><span class="p">)</span>

        <span class="c1"># Make sure only valid traits get added:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">trait</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">trait</span> <span class="o">=</span> <span class="n">Trait</span><span class="p">(</span><span class="o">*</span><span class="n">trait</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">trait</span> <span class="o">=</span> <span class="n">trait_for</span><span class="p">(</span><span class="n">trait</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># Add the trait to the class:</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_add_class_trait</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">trait</span><span class="p">,</span> <span class="n">is_subclass</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Also add the trait to all subclasses of this class:</span>
        <span class="k">for</span> <span class="n">subclass</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">trait_subclasses</span><span class="p">(</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">subclass</span><span class="o">.</span><span class="n">_add_class_trait</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">trait</span><span class="p">,</span> <span class="n">is_subclass</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_add_class_trait</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">trait</span><span class="p">,</span> <span class="n">is_subclass</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a named trait attribute to this class.</span>

<span class="sd">        Does not affect subclasses.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            Name of the attribute to add.</span>
<span class="sd">        trait : CTrait</span>
<span class="sd">            The trait to be added.</span>
<span class="sd">        is_subclass : bool</span>
<span class="sd">            True if we&#39;re adding the trait to a strict subclass of the</span>
<span class="sd">            original class that add_class_trait was called for. This is used</span>
<span class="sd">            to decide how to behave if ``cls`` already has a trait named</span>
<span class="sd">            ``name``: in that circumstance, if ``is_subclass`` is False, an</span>
<span class="sd">            error will be raised, while if ``is_subclass`` is True, no trait</span>
<span class="sd">            will be added.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        TraitError</span>
<span class="sd">            If a trait with the given name already exists, and is_subclass</span>
<span class="sd">            is ``False``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get a reference to the class&#39;s dictionary and &#39;prefix&#39; traits:</span>
        <span class="n">class_dict</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span>
        <span class="n">prefix_traits</span> <span class="o">=</span> <span class="n">class_dict</span><span class="p">[</span><span class="n">PrefixTraits</span><span class="p">]</span>

        <span class="c1"># See if the trait is a &#39;prefix&#39; trait:</span>
        <span class="k">if</span> <span class="n">name</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="o">==</span> <span class="s2">&quot;_&quot;</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">prefix_traits</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">is_subclass</span><span class="p">:</span>
                    <span class="k">return</span>
                <span class="k">raise</span> <span class="n">TraitError</span><span class="p">(</span><span class="s2">&quot;The &#39;</span><span class="si">%s</span><span class="s2">_&#39; trait is already defined.&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">prefix_traits</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">trait</span>

            <span class="c1"># Otherwise, add it to the list of known prefixes:</span>
            <span class="n">prefix_list</span> <span class="o">=</span> <span class="n">prefix_traits</span><span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">]</span>
            <span class="n">prefix_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

            <span class="c1"># Resort the list from longest to shortest:</span>
            <span class="n">prefix_list</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="nb">len</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">return</span>

        <span class="c1"># Check to see if the trait is already defined:</span>
        <span class="n">class_traits</span> <span class="o">=</span> <span class="n">class_dict</span><span class="p">[</span><span class="n">ClassTraits</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">class_traits</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">is_subclass</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">raise</span> <span class="n">TraitError</span><span class="p">(</span><span class="s2">&quot;The &#39;</span><span class="si">%s</span><span class="s2">&#39; trait is already defined.&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>

        <span class="c1"># Check to see if the trait has additional sub-traits that need to be</span>
        <span class="c1"># defined also:</span>
        <span class="n">handler</span> <span class="o">=</span> <span class="n">trait</span><span class="o">.</span><span class="n">handler</span>
        <span class="k">if</span> <span class="n">handler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">handler</span><span class="o">.</span><span class="n">has_items</span><span class="p">:</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">_add_class_trait</span><span class="p">(</span>
                    <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_items&quot;</span><span class="p">,</span>
                    <span class="n">handler</span><span class="o">.</span><span class="n">items_event</span><span class="p">(),</span>
                    <span class="n">is_subclass</span><span class="o">=</span><span class="n">is_subclass</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">handler</span><span class="o">.</span><span class="n">is_mapped</span><span class="p">:</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">_add_class_trait</span><span class="p">(</span>
                    <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span><span class="p">,</span>
                    <span class="n">mapped_trait_for</span><span class="p">(</span><span class="n">trait</span><span class="p">,</span> <span class="n">name</span><span class="p">),</span>
                    <span class="n">is_subclass</span><span class="o">=</span><span class="n">is_subclass</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="c1"># Make the new trait inheritable (if allowed):</span>
        <span class="k">if</span> <span class="n">trait</span><span class="o">.</span><span class="n">is_base</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">class_dict</span><span class="p">[</span><span class="n">BaseTraits</span><span class="p">][</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">trait</span>

        <span class="c1"># See if there are any static notifiers defined:</span>
        <span class="n">handlers</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">_get_method</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;_</span><span class="si">%s</span><span class="s2">_changed&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">),</span>
            <span class="n">_get_method</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;_</span><span class="si">%s</span><span class="s2">_fired&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">),</span>
        <span class="p">]</span>

        <span class="c1"># Add any special trait defined event handlers:</span>
        <span class="n">_add_event_handlers</span><span class="p">(</span><span class="n">trait</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">handlers</span><span class="p">)</span>

        <span class="c1"># Add the &#39;anytrait&#39; handler (if any):</span>
        <span class="n">handlers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prefix_traits</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;@&quot;</span><span class="p">))</span>

        <span class="c1"># Filter out any &#39;None&#39; values:</span>
        <span class="n">handlers</span> <span class="o">=</span> <span class="p">[</span><span class="n">h</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">handlers</span> <span class="k">if</span> <span class="n">h</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>

        <span class="c1"># If there are and handlers, add them to the trait&#39;s notifier&#39;s list:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">handlers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">trait</span> <span class="o">=</span> <span class="n">_clone_trait</span><span class="p">(</span><span class="n">trait</span><span class="p">)</span>
            <span class="n">_add_notifiers</span><span class="p">(</span><span class="n">trait</span><span class="o">.</span><span class="n">_notifiers</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span> <span class="n">handlers</span><span class="p">)</span>

        <span class="c1"># Finally, add the new trait to the class trait dictionary:</span>
        <span class="n">class_traits</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">trait</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">set_trait_dispatch_handler</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">klass</span><span class="p">,</span> <span class="n">override</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Sets a trait notification dispatch handler.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">klass</span><span class="p">,</span> <span class="n">TraitChangeNotifyWrapper</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">override</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">wrappers</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">TraitError</span><span class="p">(</span>
                        <span class="s2">&quot;A dispatch handler called &#39;</span><span class="si">%s</span><span class="s2">&#39; has &quot;</span>
                        <span class="s2">&quot;already been defined.&quot;</span> <span class="o">%</span> <span class="n">name</span>
                    <span class="p">)</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">wrappers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">klass</span>
                <span class="k">return</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">raise</span> <span class="n">TraitError</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> is not a subclass of TraitChangeNotifyWrapper.&quot;</span> <span class="o">%</span> <span class="n">klass</span>
        <span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">trait_subclasses</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="nb">all</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns a list of the immediate (or all) subclasses of this class.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        all : bool</span>
<span class="sd">            Indicates whether to return all subclasses of this class. If</span>
<span class="sd">            False, only immediate subclasses are returned.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_trait_subclasses</span><span class="p">([])</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_trait_subclasses</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">subclasses</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">subclass</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">subclass</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">subclasses</span><span class="p">:</span>
                <span class="n">subclasses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subclass</span><span class="p">)</span>
                <span class="n">subclass</span><span class="o">.</span><span class="n">_trait_subclasses</span><span class="p">(</span><span class="n">subclasses</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">subclasses</span>

    <span class="k">def</span> <span class="nf">has_traits_interface</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">interfaces</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns whether the object implements a specified traits interface.</span>

<span class="sd">        Tests whether the object implements one or more of the interfaces</span>
<span class="sd">        specified by *interfaces*. Return **True** if it does, and **False**</span>
<span class="sd">        otherwise.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        *interfaces :</span>
<span class="sd">            One or more traits Interface (sub)classes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interfaces</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns a dictionary of traits to pickle.</span>

<span class="sd">        In general, avoid overriding __getstate__ in subclasses. Instead, mark</span>
<span class="sd">        traits that should not be pickled with &#39;transient = True&#39; metadata.</span>

<span class="sd">        In cases where this strategy is not sufficient, override __getstate__</span>
<span class="sd">        in subclasses using the following pattern to remove items that should</span>
<span class="sd">        not be persisted::</span>

<span class="sd">            def __getstate__(self):</span>
<span class="sd">                state = super().__getstate__()</span>
<span class="sd">                for key in [&#39;foo&#39;, &#39;bar&#39;]:</span>
<span class="sd">                    if key in state:</span>
<span class="sd">                        del state[key]</span>
<span class="sd">                return state</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Save all traits which do not have any &#39;transient&#39; metadata:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trait_get</span><span class="p">(</span><span class="n">transient</span><span class="o">=</span><span class="n">is_none</span><span class="p">)</span>

        <span class="c1"># Add all delegate traits that explicitly have &#39;transient = False&#39;</span>
        <span class="c1"># metadata:</span>
        <span class="n">dic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span>
        <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="nb">dict</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">dic</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trait_names</span><span class="p">(</span>
                        <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;delegate&quot;</span><span class="p">,</span> <span class="n">transient</span><span class="o">=</span><span class="kc">False</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">dic</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># If this object implements ISerializable, make sure that all</span>
        <span class="c1"># contained HasTraits objects in its persisted state also implement</span>
        <span class="c1"># ISerializable:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_traits_interface</span><span class="p">(</span><span class="n">ISerializable</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">_is_serializable</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">TraitError</span><span class="p">(</span>
                        <span class="s2">&quot;The &#39;</span><span class="si">%s</span><span class="s2">&#39; trait of a &#39;</span><span class="si">%s</span><span class="s2">&#39; instance &quot;</span>
                        <span class="s2">&quot;contains the unserializable value: </span><span class="si">%s</span><span class="s2">&quot;</span>
                        <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                    <span class="p">)</span>

        <span class="c1"># Store the traits version in the state dictionary (if possible):</span>
        <span class="n">result</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;__traits_version__&quot;</span><span class="p">,</span> <span class="n">TraitsVersion</span><span class="p">)</span>

        <span class="c1"># Return the final state dictionary:</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">__reduce_ex__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">protocol</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">__newobj__</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,),</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getstate__</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">trait_change_notify</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Restores the previously pickled state of an object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pop</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">pop</span>
        <span class="k">if</span> <span class="n">pop</span><span class="p">(</span><span class="s2">&quot;__traits_version__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># If the state was saved by a version of Traits prior to 3.0, then</span>
            <span class="c1"># use Traits 2.0 compatible code to restore it:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">pop</span><span class="p">(</span><span class="n">name</span><span class="p">))</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">pop</span><span class="p">(</span><span class="s2">&quot;__HasTraits_restore__&quot;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trait_set</span><span class="p">(</span>
                <span class="n">trait_change_notify</span><span class="o">=</span><span class="n">trait_change_notify</span><span class="p">,</span> <span class="o">**</span><span class="nb">dict</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Otherwise, apply the Traits 3.0 restore logic:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_trait_listeners</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_trait_observers</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trait_set</span><span class="p">(</span><span class="n">trait_change_notify</span><span class="o">=</span><span class="n">trait_change_notify</span><span class="p">,</span> <span class="o">**</span><span class="n">state</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_post_init_trait_listeners</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_post_init_trait_observers</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">traits_init</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_trait_set_inited</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">trait_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">names</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Retrieve trait values for one or more traits.</span>

<span class="sd">        This function can be called in one of three ways. In the first form,</span>
<span class="sd">        the user passes the names of one or more traits to be retrieved::</span>

<span class="sd">            my_object.trait_get(&quot;trait_name1&quot;, &quot;trait_name2&quot;)</span>

<span class="sd">        In the second form, the user passes a list of zero or more names of</span>
<span class="sd">        traits::</span>

<span class="sd">            my_object.trait_get([&quot;trait_name1&quot;, &quot;trait_name2&quot;])</span>

<span class="sd">        In the final form, no trait names are passed, and all trait names</span>
<span class="sd">        and trait values are returned, subject to the given metadata filters::</span>

<span class="sd">            my_object.trait_get(transient=True, frombicated=False)</span>

<span class="sd">        In all cases, a dictionary mapping trait names to trait values is</span>
<span class="sd">        returned.</span>

<span class="sd">        For the first two forms, if any name does not correspond to a defined</span>
<span class="sd">        trait, it is not included in the result.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        *names</span>
<span class="sd">            Names of the traits to look up, or a single positional argument</span>
<span class="sd">            providing a sequence of trait names.</span>
<span class="sd">        **metadata</span>
<span class="sd">            Metadata information used to filter the traits to return. This</span>
<span class="sd">            information is used only when no names are provided.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        result : dict</span>
<span class="sd">            A dictionary mapping the selected trait names to their</span>
<span class="sd">            corresponding values.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">in</span> <span class="n">SequenceTypes</span><span class="p">):</span>
            <span class="n">names</span> <span class="o">=</span> <span class="n">names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trait_names</span><span class="p">(</span><span class="o">**</span><span class="n">metadata</span><span class="p">)</span>

        <span class="c1"># Sentinel for missing attributes.</span>
        <span class="n">missing</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">missing</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">missing</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="c1"># Defines the deprecated alias for &#39;trait_get&#39;</span>
    <span class="nd">@deprecated</span><span class="p">(</span><span class="s1">&#39;use &quot;HasTraits.trait_get&quot; instead&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">names</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">trait_get</span><span class="p">(</span><span class="o">*</span><span class="n">names</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">)</span>

    <span class="n">get</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">trait_get</span><span class="o">.</span><span class="vm">__doc__</span>

    <span class="k">def</span> <span class="nf">trait_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trait_change_notify</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">traits</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Shortcut for setting object trait attributes.</span>

<span class="sd">        Treats each keyword argument to the method as the name of a trait</span>
<span class="sd">        attribute and sets the corresponding trait attribute to the value</span>
<span class="sd">        specified. This is a useful shorthand when a number of trait attributes</span>
<span class="sd">        need to be set on an object, or a trait attribute value needs to be set</span>
<span class="sd">        in a lambda function. For example, you can write::</span>

<span class="sd">            person.trait_set(name=&#39;Bill&#39;, age=27)</span>

<span class="sd">        instead of::</span>

<span class="sd">            person.name = &#39;Bill&#39;</span>
<span class="sd">            person.age = 27</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        trait_change_notify : bool</span>
<span class="sd">            If **True** (the default), then each value assigned may generate a</span>
<span class="sd">            trait change notification. If **False**, then no trait change</span>
<span class="sd">            notifications will be generated. (see also: trait_setq)</span>
<span class="sd">        **traits :</span>
<span class="sd">            Key/value pairs, the trait attributes and their values to be</span>
<span class="sd">            set</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        self :</span>
<span class="sd">            The method returns this object, after setting attributes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">trait_change_notify</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_trait_change_notify</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">traits</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_trait_change_notify</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">traits</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="c1"># Defines the deprecated alias for &#39;trait_set&#39;</span>
    <span class="nd">@deprecated</span><span class="p">(</span><span class="s1">&#39;use &quot;HasTraits.trait_set&quot; instead&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trait_change_notify</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">traits</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">trait_set</span><span class="p">(</span>
            <span class="n">trait_change_notify</span><span class="o">=</span><span class="n">trait_change_notify</span><span class="p">,</span> <span class="o">**</span><span class="n">traits</span>
        <span class="p">)</span>

    <span class="nb">set</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">trait_set</span><span class="o">.</span><span class="vm">__doc__</span>

    <span class="k">def</span> <span class="nf">trait_setq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">traits</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Shortcut for setting object trait attributes.</span>

<span class="sd">        Treats each keyword argument to the method as the name of a trait</span>
<span class="sd">        attribute and sets the corresponding trait attribute to the value</span>
<span class="sd">        specified. This is a useful shorthand when a number of trait attributes</span>
<span class="sd">        need to be set on an object, or a trait attribute value needs to be set</span>
<span class="sd">        in a lambda function. For example, you can write::</span>

<span class="sd">            person.trait_setq(name=&#39;Bill&#39;, age=27)</span>

<span class="sd">        instead of::</span>

<span class="sd">            person.name = &#39;Bill&#39;</span>
<span class="sd">            person.age = 27</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        **traits :</span>
<span class="sd">            Key/value pairs, the trait attributes and their values to be set.</span>
<span class="sd">            No trait change notifications will be generated for any values</span>
<span class="sd">            assigned (see also: trait_set).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        self :</span>
<span class="sd">            The method returns this object, after setting attributes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">trait_set</span><span class="p">(</span><span class="n">trait_change_notify</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">traits</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">reset_traits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">traits</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Resets some or all of an object&#39;s trait attributes to their default</span>
<span class="sd">        values.</span>

<span class="sd">        Resets each of the traits whose names are specified in the *traits*</span>
<span class="sd">        list to their default values. If *traits* is None or omitted, the</span>
<span class="sd">        method resets all explicitly-defined object trait attributes to their</span>
<span class="sd">        default values. Note that this does not affect wildcard trait</span>
<span class="sd">        attributes or trait attributes added via add_trait(), unless they are</span>
<span class="sd">        explicitly named in *traits*.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        traits : list of strings</span>
<span class="sd">            Names of trait attributes to reset.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        unresetable : list of strings</span>
<span class="sd">            A list of attributes that the method was unable to reset, which is</span>
<span class="sd">            empty if all the attributes were successfully reset.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">unresetable</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">traits</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">traits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trait_names</span><span class="p">(</span><span class="o">**</span><span class="n">metadata</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">traits</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">delattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="n">TraitError</span><span class="p">):</span>
                <span class="n">unresetable</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">unresetable</span>

    <span class="k">def</span> <span class="nf">copyable_trait_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the list of trait names to copy or clone by default.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">metadata</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;transient&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">trait_names</span><span class="p">(</span><span class="o">**</span><span class="n">metadata</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">all_trait_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the list of all trait names, including implicitly defined</span>
<span class="sd">            traits.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class_traits__</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="k">def</span> <span class="fm">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the list of trait names when calling the dir() builtin on</span>
<span class="sd">            the object. This enables tab-completion in IPython.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__dir__</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">trait_names</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">copy_traits</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">traits</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">memo</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Copies another object&#39;s trait attributes into this one.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        other : object</span>
<span class="sd">            The object whose trait attribute values should be copied.</span>
<span class="sd">        traits : list of strings</span>
<span class="sd">            A list of names of trait attributes to copy. If None or</span>
<span class="sd">            unspecified, the set of names returned by trait_names() is used.</span>
<span class="sd">            If &#39;all&#39; or an empty list, the set of names returned by</span>
<span class="sd">            all_trait_names() is used.</span>
<span class="sd">        memo : dict</span>
<span class="sd">            A dictionary of objects that have already been copied.</span>
<span class="sd">        copy : None | &#39;deep&#39; | &#39;shallow&#39;</span>
<span class="sd">            The type of copy to perform on any trait that does not have</span>
<span class="sd">            explicit &#39;copy&#39; metadata. A value of None means &#39;copy reference&#39;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        unassignable : list of strings</span>
<span class="sd">            A list of attributes that the method was unable to copy, which is</span>
<span class="sd">            empty if all the attributes were successfully copied.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">traits</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">traits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copyable_trait_names</span><span class="p">(</span><span class="o">**</span><span class="n">metadata</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">traits</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">traits</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">traits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_trait_names</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">memo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">memo</span><span class="p">[</span><span class="s2">&quot;traits_to_copy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;all&quot;</span>

        <span class="n">unassignable</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">deferred</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">deep_copy</span> <span class="o">=</span> <span class="n">copy</span> <span class="o">==</span> <span class="s2">&quot;deep&quot;</span>
        <span class="n">shallow_copy</span> <span class="o">=</span> <span class="n">copy</span> <span class="o">==</span> <span class="s2">&quot;shallow&quot;</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">traits</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">trait</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trait</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">trait</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="n">DeferredCopy</span><span class="p">:</span>
                    <span class="n">deferred</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="n">base_trait</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">base_trait</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">base_trait</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;event&quot;</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                <span class="n">copy_type</span> <span class="o">=</span> <span class="n">base_trait</span><span class="o">.</span><span class="n">copy</span>
                <span class="k">if</span> <span class="n">copy_type</span> <span class="o">==</span> <span class="s2">&quot;shallow&quot;</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">copy_module</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">copy_type</span> <span class="o">==</span> <span class="s2">&quot;ref&quot;</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">copy_type</span> <span class="o">==</span> <span class="s2">&quot;deep&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">deep_copy</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">memo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">copy_module</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">copy_module</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">shallow_copy</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">copy_module</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">unassignable</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">deferred</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                <span class="n">copy_type</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">base_trait</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span>
                <span class="k">if</span> <span class="n">copy_type</span> <span class="o">==</span> <span class="s2">&quot;shallow&quot;</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">copy_module</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">copy_type</span> <span class="o">==</span> <span class="s2">&quot;ref&quot;</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">copy_type</span> <span class="o">==</span> <span class="s2">&quot;deep&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">deep_copy</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">memo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">copy_module</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">copy_module</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">shallow_copy</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">copy_module</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">unassignable</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">unassignable</span>

    <span class="k">def</span> <span class="nf">clone_traits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">traits</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">memo</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Clones a new object from this one, optionally copying only a</span>
<span class="sd">        specified set of traits.</span>

<span class="sd">        Creates a new object that is a clone of the current object. If *traits*</span>
<span class="sd">        is None (the default), then all explicit trait attributes defined</span>
<span class="sd">        for this object are cloned. If *traits* is &#39;all&#39; or an empty list, the</span>
<span class="sd">        list of traits returned by all_trait_names() is used; otherwise,</span>
<span class="sd">        *traits* must be a list of the names of the trait attributes to be</span>
<span class="sd">        cloned.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        traits : list of strings</span>
<span class="sd">            The list of names of the trait attributes to copy.</span>
<span class="sd">        memo : dict</span>
<span class="sd">            A dictionary of objects that have already been copied.</span>
<span class="sd">        copy : str</span>
<span class="sd">            The type of copy ``deep`` or ``shallow`` to perform on any trait</span>
<span class="sd">            that does not have explicit &#39;copy&#39; metadata. A value of None means</span>
<span class="sd">            &#39;copy reference&#39;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        new :</span>
<span class="sd">            The newly cloned object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">memo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">memo</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">traits</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">traits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copyable_trait_names</span><span class="p">(</span><span class="o">**</span><span class="n">metadata</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">traits</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">traits</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">traits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_trait_names</span><span class="p">()</span>
            <span class="n">memo</span><span class="p">[</span><span class="s2">&quot;traits_to_copy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;all&quot;</span>

        <span class="n">memo</span><span class="p">[</span><span class="s2">&quot;traits_copy_mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span>
        <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
        <span class="n">memo</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)]</span> <span class="o">=</span> <span class="n">new</span>
        <span class="n">new</span><span class="o">.</span><span class="n">_init_trait_listeners</span><span class="p">()</span>
        <span class="n">new</span><span class="o">.</span><span class="n">_init_trait_observers</span><span class="p">()</span>
        <span class="n">new</span><span class="o">.</span><span class="n">copy_traits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">traits</span><span class="p">,</span> <span class="n">memo</span><span class="p">,</span> <span class="n">copy</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">)</span>
        <span class="n">new</span><span class="o">.</span><span class="n">_post_init_trait_listeners</span><span class="p">()</span>
        <span class="n">new</span><span class="o">.</span><span class="n">_post_init_trait_observers</span><span class="p">()</span>
        <span class="n">new</span><span class="o">.</span><span class="n">traits_init</span><span class="p">()</span>
        <span class="n">new</span><span class="o">.</span><span class="n">_trait_set_inited</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">new</span>

    <span class="k">def</span> <span class="nf">__deepcopy__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Creates a deep copy of the object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">clone_traits</span><span class="p">(</span>
            <span class="n">memo</span><span class="o">=</span><span class="n">memo</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">=</span><span class="n">memo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;traits_to_copy&quot;</span><span class="p">),</span>
            <span class="n">copy</span><span class="o">=</span><span class="n">memo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;traits_copy_mode&quot;</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">edit_traits</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">view</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">kind</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">context</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">scrollable</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">args</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Displays a user interface window for editing trait attribute</span>
<span class="sd">        values.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        view : View or string</span>
<span class="sd">            A View object (or its name) that defines a user interface for</span>
<span class="sd">            editing trait attribute values of the current object. If the view</span>
<span class="sd">            is defined as an attribute on this class, use the name of the</span>
<span class="sd">            attribute. Otherwise, use a reference to the view object. If this</span>
<span class="sd">            attribute is not specified, the View object returned by</span>
<span class="sd">            trait_view() is used.</span>
<span class="sd">        parent : toolkit control</span>
<span class="sd">            The reference to a user interface component to use as the parent</span>
<span class="sd">            window for the object&#39;s UI window.</span>
<span class="sd">        kind : str</span>
<span class="sd">            The type of user interface window to create. See the</span>
<span class="sd">            **traitsui.view.kind_trait** trait for values and</span>
<span class="sd">            their meanings. If *kind* is unspecified or None, the **kind**</span>
<span class="sd">            attribute of the View object is used.</span>
<span class="sd">        context : object or dictionary</span>
<span class="sd">            A single object or a dictionary of string/object pairs, whose trait</span>
<span class="sd">            attributes are to be edited. If not specified, the current object</span>
<span class="sd">            is used.</span>
<span class="sd">        handler : Handler</span>
<span class="sd">            A handler object used for event handling in the dialog box. If</span>
<span class="sd">            None, the default handler for Traits UI is used.</span>
<span class="sd">        id : str</span>
<span class="sd">            A unique ID for persisting preferences about this user interface,</span>
<span class="sd">            such as size and position. If not specified, no user preferences</span>
<span class="sd">            are saved.</span>
<span class="sd">        scrollable : bool</span>
<span class="sd">            Indicates whether the dialog box should be scrollable. When set to</span>
<span class="sd">            True, scroll bars appear on the dialog box if it is not large</span>
<span class="sd">            enough to display all of the items in the view at one time.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        A UI object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">context</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">view</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trait_view</span><span class="p">(</span><span class="n">view</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">view</span><span class="o">.</span><span class="n">ui</span><span class="p">(</span>
            <span class="n">context</span><span class="p">,</span>
            <span class="n">parent</span><span class="p">,</span>
            <span class="n">kind</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trait_view_elements</span><span class="p">(),</span>
            <span class="n">handler</span><span class="p">,</span>
            <span class="nb">id</span><span class="p">,</span>
            <span class="n">scrollable</span><span class="p">,</span>
            <span class="n">args</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">trait_context</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the default context to use for editing or configuring</span>
<span class="sd">            traits.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;object&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">trait_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">view_element</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Gets or sets a ViewElement associated with an object&#39;s class.</span>

<span class="sd">        If both *name* and *view_element* are specified, the view element is</span>
<span class="sd">        associated with *name* for the current object&#39;s class. (That is,</span>
<span class="sd">        *view_element* is added to the ViewElements object associated with</span>
<span class="sd">        the current object&#39;s class, indexed by *name*.)</span>

<span class="sd">        If only *name* is specified, the function returns the view element</span>
<span class="sd">        object associated with *name*, or None if *name* has no associated</span>
<span class="sd">        view element. View elements retrieved by this function are those that</span>
<span class="sd">        are bound to a class attribute in the class definition, or that are</span>
<span class="sd">        associated with a name by a previous call to this method.</span>

<span class="sd">        If neither *name* nor *view_element* is specified, the method returns a</span>
<span class="sd">        View object, based on the following order of preference:</span>

<span class="sd">        1. If there is a View object named ``traits_view`` associated with the</span>
<span class="sd">           current object, it is returned.</span>
<span class="sd">        2. If there is exactly one View object associated the current</span>
<span class="sd">           object, it is returned.</span>
<span class="sd">        3. Otherwise, it returns a View object containing items for all the</span>
<span class="sd">           non-event trait attributes on the current object.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            Name of a view element</span>
<span class="sd">        view_element : ViewElement</span>
<span class="sd">            View element to associate</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        A view element.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">_trait_view</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">view_element</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">default_traits_view</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trait_view_elements</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visible_traits</span><span class="p">,</span>
            <span class="bp">self</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">class_trait_view</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">view_element</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_trait_view</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">view_element</span><span class="p">,</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">class_default_traits_view</span><span class="p">,</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">class_trait_view_elements</span><span class="p">,</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">class_visible_traits</span><span class="p">,</span>
            <span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_trait_view</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">name</span><span class="p">,</span>
        <span class="n">view_element</span><span class="p">,</span>
        <span class="n">default_name</span><span class="p">,</span>
        <span class="n">view_elements</span><span class="p">,</span>
        <span class="n">trait_selector_f</span><span class="p">,</span>
        <span class="n">handler</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Gets or sets a ViewElement associated with an object&#39;s class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If a view element was passed instead of a name or None, return it:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">AbstractViewElement</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">name</span>

        <span class="c1"># Get the ViewElements object associated with the class:</span>
        <span class="n">view_elements</span> <span class="o">=</span> <span class="n">view_elements</span><span class="p">()</span>

        <span class="c1"># The following test should only succeed for objects created before</span>
        <span class="c1"># traits has been fully initialized (such as the default Handler):</span>
        <span class="k">if</span> <span class="n">view_elements</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Provide a nicer failure mode when upgrading to Traits using</span>
        <span class="c1"># TraitsUI 6.x</span>
        <span class="n">check_traitsui_major_version</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">view_element</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># If only a name was specified, return the ViewElement it</span>
                <span class="c1"># matches, if any:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">view_elements</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">handler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="n">method</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">method</span><span class="p">):</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="n">method</span><span class="p">()</span>

                <span class="k">return</span> <span class="n">result</span>

            <span class="c1"># Otherwise, save the specified ViewElement under the name</span>
            <span class="c1"># specified:</span>
            <span class="n">view_elements</span><span class="o">.</span><span class="n">content</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">view_element</span>

            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Get the default view/view name:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">default_name</span><span class="p">()</span>

        <span class="c1"># If the default is a View, return it:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">AbstractViewElement</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">name</span>

        <span class="c1"># Otherwise, get all View objects associated with the object&#39;s class:</span>
        <span class="n">names</span> <span class="o">=</span> <span class="n">view_elements</span><span class="o">.</span><span class="n">filter_by</span><span class="p">()</span>

        <span class="c1"># If the specified default name is in the list, return its View:</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">view_elements</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">handler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">method</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">method</span><span class="p">):</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">method</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">AbstractViewElement</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">result</span>

        <span class="c1"># If there is only one View, return it:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">view_elements</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># Otherwise, create and return a View based on the set of editable</span>
        <span class="c1"># traits defined for the object:</span>
        <span class="kn">from</span> <span class="nn">traitsui.api</span> <span class="kn">import</span> <span class="n">View</span>

        <span class="k">return</span> <span class="n">View</span><span class="p">(</span><span class="n">trait_selector_f</span><span class="p">(),</span> <span class="n">buttons</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="s2">&quot;Cancel&quot;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">default_traits_view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the name of the default traits view for the object&#39;s class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">class_default_traits_view</span><span class="p">()</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">class_default_traits_view</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the name of the default traits view for the class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">DefaultTraitsView</span>

    <span class="k">def</span> <span class="nf">trait_views</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">klass</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns a list of the names of all view elements associated with</span>
<span class="sd">        the current object&#39;s class.</span>

<span class="sd">        If *klass* is specified, the list of names is filtered such that only</span>
<span class="sd">        objects that are instances of the specified class are returned.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        klass : class</span>
<span class="sd">            A class, such that all returned names must correspond to instances</span>
<span class="sd">            of this class. Possible values include:</span>

<span class="sd">            * Group</span>
<span class="sd">            * Item</span>
<span class="sd">            * View</span>
<span class="sd">            * ViewElement</span>
<span class="sd">            * ViewSubElement</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">view_elements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">ViewTraits</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">view_elements</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">view_elements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_trait_view_elements</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">view_elements</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">klass</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">trait_view_elements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the ViewElements object associated with the object&#39;s</span>
<span class="sd">        class.</span>

<span class="sd">        The returned object can be used to access all the view elements</span>
<span class="sd">        associated with the class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">class_trait_view_elements</span><span class="p">()</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">class_trait_view_elements</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the ViewElements object associated with the class.</span>

<span class="sd">        The returned object can be used to access all the view elements</span>
<span class="sd">        associated with the class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">view_elements</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">ViewTraits</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">view_elements</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">view_elements</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_init_trait_view_elements</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">view_elements</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_init_trait_view_elements</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Lazily Initialize the ViewElements object from a dictionary. &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">traitsui.view_elements</span> <span class="kn">import</span> <span class="n">ViewElements</span>

        <span class="n">hastraits_bases</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">base</span> <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__bases__</span>
            <span class="k">if</span> <span class="n">ClassTraits</span> <span class="ow">in</span> <span class="n">base</span><span class="o">.</span><span class="vm">__dict__</span>
        <span class="p">]</span>
        <span class="n">view_elements</span> <span class="o">=</span> <span class="n">ViewElements</span><span class="p">()</span>
        <span class="n">elements_dict</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">ViewTraits</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">elements_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Add the view element to the class&#39;s &#39;ViewElements&#39; if it is</span>
            <span class="c1"># not already defined (duplicate definitions are errors):</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">view_elements</span><span class="o">.</span><span class="n">content</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">TraitError</span><span class="p">(</span>
                    <span class="s2">&quot;Duplicate definition for view element &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">name</span>
                <span class="p">)</span>

            <span class="n">view_elements</span><span class="o">.</span><span class="n">content</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">element</span>

            <span class="c1"># Replace all substitutable view sub elements with &#39;Include&#39;</span>
            <span class="c1"># objects, and add the substituted items to the</span>
            <span class="c1"># &#39;ViewElements&#39;:</span>
            <span class="n">element</span><span class="o">.</span><span class="n">replace_include</span><span class="p">(</span><span class="n">view_elements</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="n">hastraits_bases</span><span class="p">:</span>
            <span class="c1"># If the base class has a &#39;ViewElements&#39; object defined, add it to</span>
            <span class="c1"># the &#39;parents&#39; list of this class&#39;s &#39;ViewElements&#39;:</span>
            <span class="n">parent_view_elements</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">class_trait_view_elements</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">parent_view_elements</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">view_elements</span><span class="o">.</span><span class="n">parents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parent_view_elements</span><span class="p">)</span>

        <span class="nb">setattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">ViewTraits</span><span class="p">,</span> <span class="n">view_elements</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">view_elements</span>

    <span class="k">def</span> <span class="nf">configure_traits</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">view</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">kind</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">edit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">context</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">scrollable</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">args</span>
    <span class="p">):</span>
        <span class="c1">### JMS: Is it correct to assume that non-modal options for &#39;kind&#39;</span>
        <span class="c1">###      behave modally when called from this method?</span>
        <span class="sd">&quot;&quot;&quot;Creates and displays a dialog box for editing values of trait</span>
<span class="sd">        attributes, as if it were a complete, self-contained GUI application.</span>

<span class="sd">        This method is intended for use in applications that do not normally</span>
<span class="sd">        have a GUI. Control does not resume in the calling application until</span>
<span class="sd">        the user closes the dialog box.</span>

<span class="sd">        The method attempts to open and unpickle the contents of *filename*</span>
<span class="sd">        before displaying the dialog box. When editing is complete, the method</span>
<span class="sd">        attempts to pickle the updated contents of the object back to</span>
<span class="sd">        *filename*. If the file referenced by *filename* does not exist, the</span>
<span class="sd">        object is not modified before displaying the dialog box. If *filename*</span>
<span class="sd">        is unspecified or None, no pickling or unpickling occurs.</span>

<span class="sd">        If *edit* is True (the default), a dialog box for editing the</span>
<span class="sd">        current object is displayed. If *edit* is False or None, no</span>
<span class="sd">        dialog box is displayed. You can use ``edit=False`` if you want the</span>
<span class="sd">        object to be restored from the contents of *filename*, without being</span>
<span class="sd">        modified by the user.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename : str</span>
<span class="sd">            The name (including path) of a file that contains a pickled</span>
<span class="sd">            representation of the current object. When this parameter is</span>
<span class="sd">            specified, the method reads the corresponding file (if it exists)</span>
<span class="sd">            to restore the saved values of the object&#39;s traits before</span>
<span class="sd">            displaying them. If the user confirms the dialog box (by clicking</span>
<span class="sd">            **OK**), the new values are written to the file. If this parameter</span>
<span class="sd">            is not specified, the values are loaded from the in-memory object,</span>
<span class="sd">            and are not persisted when the dialog box is closed.</span>

<span class="sd">            .. deprecated:: 6.0.0</span>

<span class="sd">        view : View or str</span>
<span class="sd">            A View object (or its name) that defines a user interface for</span>
<span class="sd">            editing trait attribute values of the current object. If the view</span>
<span class="sd">            is defined as an attribute on this class, use the name of the</span>
<span class="sd">            attribute. Otherwise, use a reference to the view object. If this</span>
<span class="sd">            attribute is not specified, the View object returned by</span>
<span class="sd">            trait_view() is used.</span>
<span class="sd">        kind : str</span>
<span class="sd">            The type of user interface window to create. See the</span>
<span class="sd">            **traitsui.view.kind_trait** trait for values and</span>
<span class="sd">            their meanings. If *kind* is unspecified or None, the **kind**</span>
<span class="sd">            attribute of the View object is used.</span>
<span class="sd">        edit : bool</span>
<span class="sd">            Indicates whether to display a user interface. If *filename*</span>
<span class="sd">            specifies an existing file, setting *edit* to False loads the</span>
<span class="sd">            saved values from that file into the object without requiring</span>
<span class="sd">            user interaction.</span>

<span class="sd">            .. deprecated:: 6.2.0</span>

<span class="sd">        context : object or dictionary</span>
<span class="sd">            A single object or a dictionary of string/object pairs, whose trait</span>
<span class="sd">            attributes are to be edited. If not specified, the current object</span>
<span class="sd">            is used</span>
<span class="sd">        handler : Handler</span>
<span class="sd">            A handler object used for event handling in the dialog box. If</span>
<span class="sd">            None, the default handler for Traits UI is used.</span>
<span class="sd">        id : str</span>
<span class="sd">            A unique ID for persisting preferences about this user interface,</span>
<span class="sd">            such as size and position. If not specified, no user preferences</span>
<span class="sd">            are saved.</span>
<span class="sd">        scrollable : bool</span>
<span class="sd">            Indicates whether the dialog box should be scrollable. When set to</span>
<span class="sd">            True, scroll bars appear on the dialog box if it is not large</span>
<span class="sd">            enough to display all of the items in the view at one time.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        True on success.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Restoring from pickle will not be supported starting &#39;</span>
                       <span class="s1">&#39;with traits 7.0.0&#39;</span><span class="p">)</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">copy_traits</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">Unpickler</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">edit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">edit</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s1">&#39;The edit argument to configure_traits is &#39;</span>
                <span class="s1">&#39;deprecated, and will be removed in Traits 7.0.0&#39;</span>
            <span class="p">)</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">edit</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">traitsui.api</span> <span class="kn">import</span> <span class="n">toolkit</span>

            <span class="k">if</span> <span class="n">context</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span>
            <span class="n">rc</span> <span class="o">=</span> <span class="n">toolkit</span><span class="p">()</span><span class="o">.</span><span class="n">view_application</span><span class="p">(</span>
                <span class="n">context</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trait_view</span><span class="p">(</span><span class="n">view</span><span class="p">),</span>
                <span class="n">kind</span><span class="p">,</span>
                <span class="n">handler</span><span class="p">,</span>
                <span class="nb">id</span><span class="p">,</span>
                <span class="n">scrollable</span><span class="p">,</span>
                <span class="n">args</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">rc</span> <span class="ow">and</span> <span class="p">(</span><span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
                    <span class="n">pickle</span><span class="o">.</span><span class="n">Pickler</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">rc</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">editable_traits</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns an alphabetically sorted list of the names of non-event</span>
<span class="sd">        trait attributes associated with the current object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trait_names</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">not_event</span><span class="p">,</span> <span class="n">editable</span><span class="o">=</span><span class="n">not_false</span><span class="p">)</span>
        <span class="n">names</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">names</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">class_editable_traits</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns an alphabetically sorted list of the names of non-event</span>
<span class="sd">        trait attributes associated with the current class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">names</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">class_trait_names</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">not_event</span><span class="p">,</span> <span class="n">editable</span><span class="o">=</span><span class="n">not_false</span><span class="p">)</span>
        <span class="n">names</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">names</span>

    <span class="k">def</span> <span class="nf">visible_traits</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns an alphabetically sorted list of the names of non-event</span>
<span class="sd">        trait attributes associated with the current object, that should be GUI</span>
<span class="sd">        visible</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">trait_names</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">not_event</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="n">not_false</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">class_visible_traits</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns an alphabetically sorted list of the names of non-event</span>
<span class="sd">        trait attributes associated with the current class, that should be GUI</span>
<span class="sd">        visible</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">class_trait_names</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">not_event</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="n">not_false</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">print_traits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">show_help</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Prints the values of all explicitly-defined, non-event trait</span>
<span class="sd">        attributes on the current object, in an easily readable format.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        show_help : bool</span>
<span class="sd">            Indicates whether to display additional descriptive information.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trait_names</span><span class="p">(</span><span class="o">**</span><span class="n">metadata</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trait_names</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">not_event</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pad</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">names</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">maxval</span> <span class="o">=</span> <span class="mi">78</span> <span class="o">-</span> <span class="n">pad</span>
        <span class="n">names</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">n&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">maxval</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">...</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">value</span><span class="p">[:(</span><span class="n">maxval</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">],</span>
                        <span class="n">value</span><span class="p">[</span><span class="o">-</span><span class="p">((</span><span class="n">maxval</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">):],</span>
                    <span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;&lt;undefined&gt;&quot;</span>
            <span class="n">lname</span> <span class="o">=</span> <span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">pad</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">show_help</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="se">\n</span><span class="s2">   The value must be </span><span class="si">%s</span><span class="s2">.&quot;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">lname</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_trait</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">setter</span><span class="o">.</span><span class="n">info</span><span class="p">())</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lname</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_on_trait_change</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">handler</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">remove</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">dispatch</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">,</span>
        <span class="n">priority</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">target</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Causes the object to invoke a handler whenever a trait attribute</span>
<span class="sd">        is modified, or removes the association.</span>

<span class="sd">        Multiple handlers can be defined for the same object, or even for the</span>
<span class="sd">        same trait attribute on the same object. If *name* is not specified or</span>
<span class="sd">        is None, *handler* is invoked when any trait attribute on the</span>
<span class="sd">        object is changed.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        handler : function</span>
<span class="sd">            A trait notification function for the attribute specified by</span>
<span class="sd">            *name*.</span>
<span class="sd">        name : str</span>
<span class="sd">            Specifies the trait attribute whose value changes trigger the</span>
<span class="sd">            notification.</span>
<span class="sd">        remove : bool</span>
<span class="sd">            If True, removes the previously-set association between</span>
<span class="sd">            *handler* and *name*; if False (the default), creates the</span>
<span class="sd">            association.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">name_i</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_on_trait_change</span><span class="p">(</span>
                    <span class="n">handler</span><span class="p">,</span> <span class="n">name_i</span><span class="p">,</span> <span class="n">remove</span><span class="p">,</span> <span class="n">dispatch</span><span class="p">,</span> <span class="n">priority</span><span class="p">,</span> <span class="n">target</span>
                <span class="p">)</span>

            <span class="k">return</span>

        <span class="n">name</span> <span class="o">=</span> <span class="n">name</span> <span class="ow">or</span> <span class="s2">&quot;anytrait&quot;</span>

        <span class="k">if</span> <span class="n">remove</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;anytrait&quot;</span><span class="p">:</span>
                <span class="n">notifiers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_notifiers</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">trait</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trait</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">trait</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span>
                <span class="n">notifiers</span> <span class="o">=</span> <span class="n">trait</span><span class="o">.</span><span class="n">_notifiers</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">notifiers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">notifier</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">notifiers</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">notifier</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">handler</span><span class="p">):</span>
                        <span class="k">del</span> <span class="n">notifiers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">notifier</span><span class="o">.</span><span class="n">dispose</span><span class="p">()</span>
                        <span class="k">break</span>

            <span class="k">return</span>

        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;anytrait&quot;</span><span class="p">:</span>
            <span class="n">notifiers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_notifiers</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">notifiers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trait</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">_notifiers</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">notifier</span> <span class="ow">in</span> <span class="n">notifiers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">notifier</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">handler</span><span class="p">):</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wrapper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrappers</span><span class="p">[</span><span class="n">dispatch</span><span class="p">](</span><span class="n">handler</span><span class="p">,</span> <span class="n">notifiers</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">priority</span><span class="p">:</span>
                <span class="n">notifiers</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">wrapper</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">notifiers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wrapper</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">observe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span> <span class="n">expression</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">remove</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dispatch</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Causes the object to invoke a handler whenever a trait attribute</span>
<span class="sd">        matching a specified pattern is modified, or removes the association.</span>

<span class="sd">        The *expression* parameter can be a single string or an Expression</span>
<span class="sd">        object. A list of expressions is also accepted.</span>

<span class="sd">        When *expression* is a string, its content should follow Traits Mini</span>
<span class="sd">        Language semantics:</span>

<span class="sd">        ============================== ======================================</span>
<span class="sd">        Expression                       Meaning</span>
<span class="sd">        ============================== ======================================</span>
<span class="sd">        ``item1.item2``                Observes trait *item2* on the object</span>
<span class="sd">                                       under trait *item1*.</span>
<span class="sd">                                       Changes to either *item1* or *item2*</span>
<span class="sd">                                       cause a notification to be fired.</span>
<span class="sd">        ``item1:item2``                Similar to the above, except changes</span>
<span class="sd">                                       to *item1* will not fire events</span>
<span class="sd">                                       (the &#39;:&#39; indicates no notifications).</span>
<span class="sd">        ``[item1, item2, ..., itemN]`` A list which matches any of the</span>
<span class="sd">                                       specified items. Each item can itself</span>
<span class="sd">                                       be an expression.</span>
<span class="sd">        ``items``                      Special keyword for observing a trait</span>
<span class="sd">                                       named *items* or items inside a list /</span>
<span class="sd">                                       dict / set.</span>
<span class="sd">        ``+metadata_name``             Matches any trait on the object having</span>
<span class="sd">                                       *metadata_name* metadata.</span>
<span class="sd">        ============================== ======================================</span>

<span class="sd">        All spaces will be ignored.</span>

<span class="sd">        The :py:class:`ObserverExpression` object supports</span>
<span class="sd">        the above features and more.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        handler : callable(event)</span>
<span class="sd">            A callable that will be invoked when the observed trait changes.</span>
<span class="sd">            It must accept one argument, which is an event object providing</span>
<span class="sd">            information about the change.</span>
<span class="sd">            See :py:mod:`traits.observation.events` for details.</span>
<span class="sd">        expression : str or list or ObserverExpression</span>
<span class="sd">            A description of what traits are being observed.</span>
<span class="sd">            If this is a list, each item must be a string or an Expression.</span>
<span class="sd">        remove : boolean, optional</span>
<span class="sd">            Whether to remove the event handler. Default is to add the event</span>
<span class="sd">            handler.</span>
<span class="sd">        dispatch : str, optional</span>
<span class="sd">            A string indicating how the handler should be run.</span>
<span class="sd">            Default is to run on the same thread where the change occurs.</span>

<span class="sd">            Possible values are:</span>

<span class="sd">            =========== =======================================================</span>
<span class="sd">            value       dispatch</span>
<span class="sd">            =========== =======================================================</span>
<span class="sd">            ``same``    Run notifications on the same thread where the change</span>
<span class="sd">                        occurs. The notifications are executed immediately.</span>
<span class="sd">            ``ui``      Run notifications on the UI thread. If the current</span>
<span class="sd">                        thread is the UI thread, the notifications are executed</span>
<span class="sd">                        immediately; otherwise, they are placed on the UI</span>
<span class="sd">                        event queue.</span>
<span class="sd">            =========== =======================================================</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        NotifierNotFound</span>
<span class="sd">            When attempting to remove a handler that doesn&#39;t exist.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">graphs</span> <span class="o">=</span> <span class="n">_compile_expression</span><span class="p">(</span><span class="n">expression</span><span class="p">)</span>

        <span class="n">observe_api</span><span class="o">.</span><span class="n">apply_observers</span><span class="p">(</span>
            <span class="nb">object</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">graphs</span><span class="o">=</span><span class="n">graphs</span><span class="p">,</span>
            <span class="n">handler</span><span class="o">=</span><span class="n">handler</span><span class="p">,</span>
            <span class="n">dispatcher</span><span class="o">=</span><span class="n">_ObserverDispatchers</span><span class="p">[</span><span class="n">dispatch</span><span class="p">],</span>
            <span class="n">remove</span><span class="o">=</span><span class="n">remove</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">on_trait_change</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">handler</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">remove</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">dispatch</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">,</span>
        <span class="n">priority</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">deferred</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">target</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Causes the object to invoke a handler whenever a trait attribute</span>
<span class="sd">        matching a specified pattern is modified, or removes the association.</span>

<span class="sd">        Multiple handlers can be defined for the same object, or even for the</span>
<span class="sd">        same trait attribute on the same object. If *name* is not specified or</span>
<span class="sd">        is None, *handler* is invoked when any trait attribute on the</span>
<span class="sd">        object is changed.</span>

<span class="sd">        The *name* parameter is a single *xname* or a list of *xname* names,</span>
<span class="sd">        where an *xname* is an extended name of the form::</span>

<span class="sd">            xname2[(&#39;.&#39;|&#39;:&#39;) xname2]*</span>

<span class="sd">        An *xname2* is of the form::</span>

<span class="sd">            ( xname3 | &#39;[&#39;xname3[&#39;,&#39;xname3]*&#39;]&#39; ) [&#39;*&#39;]</span>

<span class="sd">        An *xname3* is of the form::</span>

<span class="sd">             xname | [&#39;+&#39;|&#39;-&#39;][name] | name[&#39;?&#39; | (&#39;+&#39;|&#39;-&#39;)[name]]</span>

<span class="sd">        A *name* is any valid Python attribute name. The semantic meaning of</span>
<span class="sd">        this notation is as follows:</span>

<span class="sd">        ================================ ======================================</span>
<span class="sd">        expression                       meaning</span>
<span class="sd">        ================================ ======================================</span>
<span class="sd">        ``item1.item2``                  means *item1* is a trait containing an</span>
<span class="sd">                                         object (or objects if *item1* is a</span>
<span class="sd">                                         list or dict) with a trait called</span>
<span class="sd">                                         *item2*. Changes to either *item1* or</span>
<span class="sd">                                         *item2* cause a notification to be</span>
<span class="sd">                                         generated.</span>
<span class="sd">        ``item1:item2``                  means *item1* is a trait containing an</span>
<span class="sd">                                         object (or objects if *item1* is a</span>
<span class="sd">                                         list or dict) with a trait called</span>
<span class="sd">                                         *item2*. Changes to *item2* cause a</span>
<span class="sd">                                         notification to be generated, while</span>
<span class="sd">                                         changes to *item1* do not (i.e., the</span>
<span class="sd">                                         &#39;:&#39; indicates that changes to the</span>
<span class="sd">                                         *link* object should not be reported).</span>
<span class="sd">        ``[ item1, item2, ..., itemN ]`` A list which matches any of the</span>
<span class="sd">                                         specified items. Note that at the</span>
<span class="sd">                                         topmost level, the surrounding square</span>
<span class="sd">                                         brackets are optional.</span>
<span class="sd">        ``name?``                        If the current object does not have an</span>
<span class="sd">                                         attribute called *name*, the reference</span>
<span class="sd">                                         can be ignored. If the &#39;?&#39; character</span>
<span class="sd">                                         is omitted, the current object must</span>
<span class="sd">                                         have a trait called *name*, otherwise</span>
<span class="sd">                                         an exception will be raised.</span>
<span class="sd">        ``prefix+``                      Matches any trait on the object whose</span>
<span class="sd">                                         name begins with *prefix*.</span>
<span class="sd">        ``+metadata_name``               Matches any trait on the object having</span>
<span class="sd">                                         *metadata_name* metadata.</span>
<span class="sd">        ``-metadata_name``               Matches any trait on the object which</span>
<span class="sd">                                         does not have *metadata_name*</span>
<span class="sd">                                         metadata.</span>
<span class="sd">        ``prefix+metadata_name``         Matches any trait on the object whose</span>
<span class="sd">                                         name begins with *prefix* and which</span>
<span class="sd">                                         has *metadata_name* metadata.</span>
<span class="sd">        ``prefix-metadata_name``         Matches any trait on the object</span>
<span class="sd">                                         whose name begins with *prefix* and</span>
<span class="sd">                                         which does not have *metadata_name*</span>
<span class="sd">                                         metadata.</span>
<span class="sd">        ``+``                            Matches all traits on the object.</span>
<span class="sd">        ``pattern*``                     Matches object graphs where *pattern*</span>
<span class="sd">                                         occurs one or more times (useful for</span>
<span class="sd">                                         setting up listeners on recursive data</span>
<span class="sd">                                         structures like trees or linked</span>
<span class="sd">                                         lists).</span>
<span class="sd">        ================================ ======================================</span>

<span class="sd">        Some examples of valid names and their meaning are as follows:</span>

<span class="sd">        ======================= ===============================================</span>
<span class="sd">        example                 meaning</span>
<span class="sd">        ======================= ===============================================</span>
<span class="sd">        ``foo,bar,baz``         Listen for trait changes to *object.foo*,</span>
<span class="sd">                                *object.bar*, and *object.baz*.</span>
<span class="sd">        ``[&#39;foo&#39;,&#39;bar&#39;,&#39;baz&#39;]`` Equivalent to &#39;foo,bar,baz&#39;, but may be more</span>
<span class="sd">                                useful in cases where the individual items are</span>
<span class="sd">                                computed.</span>
<span class="sd">        ``foo.bar.baz``         Listen for trait changes to</span>
<span class="sd">                                *object.foo.bar.baz* and report changes to</span>
<span class="sd">                                *object.foo*, *object.foo.bar* or</span>
<span class="sd">                                *object.foo.bar.baz*.</span>
<span class="sd">        ``foo:bar:baz``         Listen for changes to *object.foo.bar.baz*, and</span>
<span class="sd">                                only report changes to *object.foo.bar.baz*.</span>
<span class="sd">        ``foo.[bar,baz]``       Listen for trait changes to *object.foo.bar*</span>
<span class="sd">                                and *object.foo.baz*.</span>
<span class="sd">        ``[left,right]*.name``  Listen for trait changes to the *name* trait of</span>
<span class="sd">                                each node of a tree having *left* and *right*</span>
<span class="sd">                                links to other tree nodes, and where *object*</span>
<span class="sd">                                the method is applied to the root node of the</span>
<span class="sd">                                tree.</span>
<span class="sd">        ``+dirty``              Listen for trait changes on any trait in the</span>
<span class="sd">                                *object* which has the &#39;dirty&#39; metadata set.</span>
<span class="sd">        ``foo.+dirty``          Listen for trait changes on any trait in</span>
<span class="sd">                                *object.foo* which has the &#39;dirty&#39; metadata</span>
<span class="sd">                                set.</span>
<span class="sd">        ``foo.[bar,-dirty]``    Listen for trait changes on *object.foo.bar* or</span>
<span class="sd">                                any trait on *object.foo* which does not have</span>
<span class="sd">                                &#39;dirty&#39; metadata set.</span>
<span class="sd">        ======================= ===============================================</span>


<span class="sd">        Note that any of the intermediate (i.e., non-final) links in a</span>
<span class="sd">        pattern can be traits of type Instance, List or Dict. In the case</span>
<span class="sd">        of List and Dict traits, the subsequent portion of the pattern is</span>
<span class="sd">        applied to each item in the list, or value in the dictionary.</span>

<span class="sd">        For example, if the self.children is a list, &#39;children.name&#39;</span>
<span class="sd">        listens for trait changes to the *name* trait for each item in the</span>
<span class="sd">        self.children list.</span>

<span class="sd">        Note that items added to or removed from a list or dictionary in</span>
<span class="sd">        the pattern will cause the *handler* routine to be invoked as well,</span>
<span class="sd">        since this is treated as an *implied* change to the item&#39;s trait</span>
<span class="sd">        being monitored.</span>

<span class="sd">        The signature of the *handler* supplied also has an effect on</span>
<span class="sd">        how changes to intermediate traits are processed. The five valid</span>
<span class="sd">        handler signatures are:</span>

<span class="sd">        1. handler()</span>
<span class="sd">        2. handler(new)</span>
<span class="sd">        3. handler(name,new)</span>
<span class="sd">        4. handler(object,name,new)</span>
<span class="sd">        5. handler(object,name,old,new)</span>

<span class="sd">        For signatures 1, 4 and 5, any change to any element of a path</span>
<span class="sd">        being listened to invokes the handler with information about the</span>
<span class="sd">        particular element that was modified (e.g., if the item being</span>
<span class="sd">        monitored is &#39;foo.bar.baz&#39;, a change to &#39;bar&#39; will call *handler*</span>
<span class="sd">        with the following information:</span>

<span class="sd">        - object: object.foo</span>
<span class="sd">        - name:   bar</span>
<span class="sd">        - old:    old value for object.foo.bar</span>
<span class="sd">        - new:    new value for object.foo.bar</span>

<span class="sd">        If one of the intermediate links is a List or Dict, the call to</span>
<span class="sd">        *handler* may report an *_items* changed event. If in the previous</span>
<span class="sd">        example, *bar* is a List, and a new item is added to *bar*, then</span>
<span class="sd">        the information passed to *handler* would be:</span>

<span class="sd">        - object: object.foo</span>
<span class="sd">        - name:   bar_items</span>
<span class="sd">        - old:    Undefined</span>
<span class="sd">        - new:    TraitListEvent whose *added* trait contains the new item</span>
<span class="sd">                  added to *bar*.</span>

<span class="sd">        For signatures 2 and 3, the *handler* does not receive enough</span>
<span class="sd">        information to discern between a change to the final trait being</span>
<span class="sd">        listened to and a change to an intermediate link. In this case,</span>
<span class="sd">        the event dispatcher will attempt to map a change to an</span>
<span class="sd">        intermediate link to its effective change on the final trait. This</span>
<span class="sd">        only works if all of the intermediate links are single values (such</span>
<span class="sd">        as an Instance or Any trait) and not Lists or Dicts. If the modified</span>
<span class="sd">        intermediate trait or any subsequent intermediate trait preceding</span>
<span class="sd">        the final trait is a List or Dict, then a TraitError is raised,</span>
<span class="sd">        since the effective value for the final trait cannot in general be</span>
<span class="sd">        resolved unambiguously. To prevent TraitErrors in this case, use the</span>
<span class="sd">        &#39;:&#39; separator to suppress notifications for changes to any of the</span>
<span class="sd">        intermediate links.</span>

<span class="sd">        Handler signature 1 also has the special characteristic that if a</span>
<span class="sd">        final trait is a List or Dict, it will automatically handle &#39;_items&#39;</span>
<span class="sd">        changed events for the final trait as well. This can be useful in</span>
<span class="sd">        cases where the *handler* only needs to know that some aspect of the</span>
<span class="sd">        final trait has been changed. For all other *handler* signatures,</span>
<span class="sd">        you must explicitly specify the &#39;xxx_items&#39; trait if you want to</span>
<span class="sd">        be notified of changes to any of the items of the &#39;xxx&#39; trait.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        handler : function</span>
<span class="sd">            A trait notification function for the *name* trait attribute, with</span>
<span class="sd">            one of the signatures described below.</span>
<span class="sd">        name : str</span>
<span class="sd">            The name of the trait attribute whose value changes trigger the</span>
<span class="sd">            notification. The *name* can specify complex patterns of trait</span>
<span class="sd">            changes using an extended *name* syntax, which is described below.</span>
<span class="sd">        remove : bool</span>
<span class="sd">            If True, removes the previously-set association between</span>
<span class="sd">            *handler* and *name*; if False (the default), creates the</span>
<span class="sd">            association.</span>
<span class="sd">        dispatch : str</span>
<span class="sd">            A string indicating the thread on which notifications must be run.</span>
<span class="sd">            Possible values are:</span>

<span class="sd">            =========== =======================================================</span>
<span class="sd">            value       dispatch</span>
<span class="sd">            =========== =======================================================</span>
<span class="sd">            ``same``    Run notifications on the same thread as this one.</span>
<span class="sd">            ``ui``      Run notifications on the UI thread. If the current</span>
<span class="sd">                        thread is the UI thread, the notifications are executed</span>
<span class="sd">                        immediately; otherwise, they are placed on the UI</span>
<span class="sd">                        event queue.</span>
<span class="sd">            ``fast_ui`` Alias for ``ui``.</span>
<span class="sd">            ``new``     Run notifications in a new thread.</span>
<span class="sd">            =========== =======================================================</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        HasTraits.observe : A newer API for defining traits notifications.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check to see if we can do a quick exit to the basic trait change</span>
        <span class="c1"># handler:</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
            <span class="ow">and</span> <span class="p">(</span><span class="n">extended_trait_pat</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
        <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_on_trait_change</span><span class="p">(</span>
                <span class="n">handler</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">remove</span><span class="p">,</span> <span class="n">dispatch</span><span class="p">,</span> <span class="n">priority</span><span class="p">,</span> <span class="n">target</span>
            <span class="p">)</span>

            <span class="k">return</span>

        <span class="kn">from</span> <span class="nn">.traits_listener</span> <span class="kn">import</span> <span class="p">(</span>
            <span class="n">TraitsListener</span><span class="p">,</span>
            <span class="n">ListenerParser</span><span class="p">,</span>
            <span class="n">ListenerHandler</span><span class="p">,</span>
            <span class="n">ListenerNotifyWrapper</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">name_i</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">on_trait_change</span><span class="p">(</span>
                    <span class="n">handler</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">name_i</span><span class="p">,</span>
                    <span class="n">remove</span><span class="o">=</span><span class="n">remove</span><span class="p">,</span>
                    <span class="n">dispatch</span><span class="o">=</span><span class="n">dispatch</span><span class="p">,</span>
                    <span class="n">priority</span><span class="o">=</span><span class="n">priority</span><span class="p">,</span>
                    <span class="n">deferred</span><span class="o">=</span><span class="n">deferred</span><span class="p">,</span>
                    <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">return</span>

        <span class="c1"># Make sure we have a name string:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="p">(</span><span class="n">name</span> <span class="ow">or</span> <span class="s2">&quot;anytrait&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">remove</span><span class="p">:</span>
            <span class="nb">dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">TraitsListener</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">listeners</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">listeners</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">wrapper</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">listeners</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">wrapper</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">handler</span><span class="p">):</span>
                            <span class="k">del</span> <span class="n">listeners</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">listeners</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="k">del</span> <span class="nb">dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">TraitsListener</span><span class="p">]</span>
                            <span class="n">wrapper</span><span class="o">.</span><span class="n">listener</span><span class="o">.</span><span class="n">unregister</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                            <span class="n">wrapper</span><span class="o">.</span><span class="n">dispose</span><span class="p">()</span>
                            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">TraitsListener</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">listeners</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">for</span> <span class="n">wrapper</span> <span class="ow">in</span> <span class="n">listeners</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">wrapper</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">handler</span><span class="p">):</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># The listener notify wrapper needs a reference to the</span>
                <span class="c1"># listener, and the listener needs a (weak) reference to the</span>
                <span class="c1"># wrapper. We first construct the wrapper with a listener of</span>
                <span class="c1"># `None`, then construct the listener with its reference to the</span>
                <span class="c1"># wrapper, then we replace the `None` listener with the correct</span>
                <span class="c1"># one.</span>
                <span class="n">lnw</span> <span class="o">=</span> <span class="n">ListenerNotifyWrapper</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
                <span class="n">listener</span> <span class="o">=</span> <span class="n">ListenerParser</span><span class="p">(</span>
                    <span class="n">name</span><span class="p">,</span>
                    <span class="n">handler</span><span class="o">=</span><span class="n">ListenerHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">),</span>
                    <span class="n">wrapped_handler_ref</span><span class="o">=</span><span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">lnw</span><span class="p">),</span>
                    <span class="n">dispatch</span><span class="o">=</span><span class="n">dispatch</span><span class="p">,</span>
                    <span class="n">priority</span><span class="o">=</span><span class="n">priority</span><span class="p">,</span>
                    <span class="n">deferred</span><span class="o">=</span><span class="n">deferred</span><span class="p">,</span>
                    <span class="n">handler_type</span><span class="o">=</span><span class="n">lnw</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                <span class="p">)</span><span class="o">.</span><span class="n">listener</span>
                <span class="n">lnw</span><span class="o">.</span><span class="n">listener</span> <span class="o">=</span> <span class="n">listener</span>
                <span class="n">listener</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="n">listeners</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lnw</span><span class="p">)</span>

    <span class="c1"># A synonym for &#39;on_trait_change&#39;</span>
    <span class="n">on_trait_event</span> <span class="o">=</span> <span class="n">on_trait_change</span>

    <span class="k">def</span> <span class="nf">sync_trait</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">trait_name</span><span class="p">,</span> <span class="nb">object</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mutual</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">remove</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Synchronizes the value of a trait attribute on this object with a</span>
<span class="sd">        trait attribute on another object.</span>

<span class="sd">        In mutual synchronization, any change to the value of the specified</span>
<span class="sd">        trait attribute of either object results in the same value being</span>
<span class="sd">        assigned to the corresponding trait attribute of the other object.</span>
<span class="sd">        In one-way synchronization, any change to the value of the attribute</span>
<span class="sd">        on this object causes the corresponding trait attribute of *object* to</span>
<span class="sd">        be updated, but not vice versa.</span>

<span class="sd">        For ``List`` traits, the list&#39;s items are also synchronized, so that</span>
<span class="sd">        mutations to this trait&#39;s list will be reflected in the synchronized</span>
<span class="sd">        list (and vice versa in the case of mutual synchronization). For</span>
<span class="sd">        ``Dict`` and ``Set`` traits, items are not synchronized.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            Name of the trait attribute on this object.</span>
<span class="sd">        object : object</span>
<span class="sd">            The object with which to synchronize.</span>
<span class="sd">        alias : str</span>
<span class="sd">            Name of the trait attribute on *other*; if None or omitted, same</span>
<span class="sd">            as *name*.</span>
<span class="sd">        mutual : bool or int</span>
<span class="sd">            Indicates whether synchronization is mutual (True or non-zero)</span>
<span class="sd">            or one-way (False or zero)</span>
<span class="sd">        remove : bool or int</span>
<span class="sd">            Indicates whether synchronization is being added (False or zero)</span>
<span class="sd">            or removed (True or non-zero)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">alias</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">alias</span> <span class="o">=</span> <span class="n">trait_name</span>

        <span class="n">is_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_list_trait</span><span class="p">(</span><span class="n">trait_name</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">object</span><span class="o">.</span><span class="n">_is_list_trait</span><span class="p">(</span>
            <span class="n">alias</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">remove</span><span class="p">:</span>
            <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_sync_trait_info</span><span class="p">()</span>
            <span class="n">dic</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">trait_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dic</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="nb">object</span><span class="p">),</span> <span class="n">alias</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dic</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">dic</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dic</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">del</span> <span class="n">info</span><span class="p">[</span><span class="n">trait_name</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_on_trait_change</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_sync_trait_modified</span><span class="p">,</span> <span class="n">trait_name</span><span class="p">,</span> <span class="n">remove</span><span class="o">=</span><span class="kc">True</span>
                        <span class="p">)</span>

                        <span class="k">if</span> <span class="n">is_list</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_on_trait_change</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_sync_trait_items_modified</span><span class="p">,</span>
                                <span class="n">trait_name</span> <span class="o">+</span> <span class="s2">&quot;_items&quot;</span><span class="p">,</span>
                                <span class="n">remove</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="p">)</span>

            <span class="k">if</span> <span class="n">mutual</span><span class="p">:</span>
                <span class="nb">object</span><span class="o">.</span><span class="n">sync_trait</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">trait_name</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

            <span class="k">return</span>

        <span class="c1"># Callback to use when the synced object goes out of scope. In order</span>
        <span class="c1"># to avoid reference cycles, this must not be a member function. See</span>
        <span class="c1"># Github issue #69 for more detail.</span>
        <span class="k">def</span> <span class="nf">_sync_trait_listener_deleted</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">dic</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">dic</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                        <span class="k">if</span> <span class="n">ref</span> <span class="ow">is</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                            <span class="k">del</span> <span class="n">dic</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dic</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">del</span> <span class="n">info</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_sync_trait_info</span><span class="p">()</span>
        <span class="n">dic</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">trait_name</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="nb">object</span><span class="p">),</span> <span class="n">alias</span><span class="p">)</span>

        <span class="n">callback</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">ref</span><span class="p">:</span> <span class="n">_sync_trait_listener_deleted</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="n">callback</span><span class="p">),</span> <span class="n">alias</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dic</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dic</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_on_trait_change</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sync_trait_modified</span><span class="p">,</span> <span class="n">trait_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">is_list</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_on_trait_change</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_sync_trait_items_modified</span><span class="p">,</span> <span class="n">trait_name</span> <span class="o">+</span> <span class="s2">&quot;_items&quot;</span>
                    <span class="p">)</span>
            <span class="n">dic</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="n">alias</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trait_name</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">mutual</span><span class="p">:</span>
            <span class="nb">object</span><span class="o">.</span><span class="n">sync_trait</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">trait_name</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_sync_trait_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">info</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;__sync_trait__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s2">&quot;__sync_trait__&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">info</span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">return</span> <span class="n">info</span>

    <span class="k">def</span> <span class="nf">_sync_trait_modified</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">object</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">):</span>
        <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sync_trait__</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">info</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">locked</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span>
        <span class="n">locked</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="nb">object</span><span class="p">,</span> <span class="n">object_name</span> <span class="ow">in</span> <span class="n">info</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="nb">object</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">object_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">object</span><span class="o">.</span><span class="n">_get_sync_trait_info</span><span class="p">()[</span><span class="s2">&quot;&quot;</span><span class="p">]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="n">object_name</span><span class="p">,</span> <span class="n">new</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>

        <span class="k">del</span> <span class="n">locked</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_sync_trait_items_modified</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">object</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="n">n0</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">index</span>
        <span class="n">n1</span> <span class="o">=</span> <span class="n">n0</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">removed</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">[:</span><span class="o">-</span><span class="mi">6</span><span class="p">]</span>
        <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sync_trait__</span>
        <span class="n">locked</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span>
        <span class="n">locked</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="nb">object</span><span class="p">,</span> <span class="n">object_name</span> <span class="ow">in</span> <span class="n">info</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="nb">object</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">object_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">object</span><span class="o">.</span><span class="n">_get_sync_trait_info</span><span class="p">()[</span><span class="s2">&quot;&quot;</span><span class="p">]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="nb">getattr</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="n">object_name</span><span class="p">)[</span><span class="n">n0</span><span class="p">:</span><span class="n">n1</span><span class="p">]</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">added</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>

        <span class="k">del</span> <span class="n">locked</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_is_list_trait</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trait_name</span><span class="p">):</span>
        <span class="n">handler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_trait</span><span class="p">(</span><span class="n">trait_name</span><span class="p">)</span><span class="o">.</span><span class="n">handler</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">handler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="n">handler</span><span class="o">.</span><span class="n">default_value_type</span> <span class="o">==</span> <span class="n">DefaultValue</span><span class="o">.</span><span class="n">trait_list_object</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_trait</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">trait</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds a trait attribute to this object.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            Name of the attribute to add.</span>
<span class="sd">        *trait :</span>
<span class="sd">            Trait or a value that can be converted to a trait by Trait().</span>
<span class="sd">            Trait definition for *name*. If more than one value is specified,</span>
<span class="sd">            it is equivalent to passing the entire list of values to Trait().</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Make sure a trait argument was specified:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">trait</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No trait definition was specified.&quot;</span><span class="p">)</span>

        <span class="c1"># Make sure only valid traits get added:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">trait</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">trait</span> <span class="o">=</span> <span class="n">Trait</span><span class="p">(</span><span class="o">*</span><span class="n">trait</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">trait</span> <span class="o">=</span> <span class="n">trait_for</span><span class="p">(</span><span class="n">trait</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># Check to see if the trait has additional sub-traits that need to be</span>
        <span class="c1"># defined also:</span>
        <span class="n">handler</span> <span class="o">=</span> <span class="n">trait</span><span class="o">.</span><span class="n">handler</span>
        <span class="k">if</span> <span class="n">handler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">handler</span><span class="o">.</span><span class="n">has_items</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_items&quot;</span><span class="p">,</span> <span class="n">handler</span><span class="o">.</span><span class="n">items_event</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">handler</span><span class="o">.</span><span class="n">is_mapped</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="n">mapped_trait_for</span><span class="p">(</span><span class="n">trait</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>

        <span class="c1"># See if there already is a class or instance trait with the same name:</span>
        <span class="n">old_trait</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trait</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Get the object&#39;s instance trait dictionary and add a clone of the new</span>
        <span class="c1"># trait to it:</span>
        <span class="n">itrait_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_instance_traits</span><span class="p">()</span>
        <span class="n">itrait_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">trait</span> <span class="o">=</span> <span class="n">_clone_trait</span><span class="p">(</span><span class="n">trait</span><span class="p">)</span>

        <span class="c1"># If there already was a trait with the same name:</span>
        <span class="k">if</span> <span class="n">old_trait</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Copy the old traits notifiers into the new trait:</span>
            <span class="n">old_notifiers</span> <span class="o">=</span> <span class="n">old_trait</span><span class="o">.</span><span class="n">_notifiers</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">old_notifiers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">trait</span><span class="o">.</span><span class="n">_notifiers</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">old_notifiers</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Otherwise, see if there are any static notifiers that should be</span>
            <span class="c1"># applied to the trait:</span>
            <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span>
            <span class="n">handlers</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">_get_method</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;_</span><span class="si">%s</span><span class="s2">_changed&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">),</span>
                <span class="n">_get_method</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;_</span><span class="si">%s</span><span class="s2">_fired&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">),</span>
            <span class="p">]</span>

            <span class="c1"># Add any special trait defined event handlers:</span>
            <span class="n">_add_event_handlers</span><span class="p">(</span><span class="n">trait</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">handlers</span><span class="p">)</span>

            <span class="c1"># Add the &#39;anytrait&#39; handler (if any):</span>
            <span class="n">handlers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__prefix_traits__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;@&quot;</span><span class="p">))</span>

            <span class="c1"># Filter out any &#39;None&#39; values:</span>
            <span class="n">handlers</span> <span class="o">=</span> <span class="p">[</span><span class="n">h</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">handlers</span> <span class="k">if</span> <span class="n">h</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>

            <span class="c1"># If there are any static notifiers, attach them to the trait:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">handlers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">_add_notifiers</span><span class="p">(</span><span class="n">trait</span><span class="o">.</span><span class="n">_notifiers</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span> <span class="n">handlers</span><span class="p">)</span>

        <span class="c1"># If this was a new trait, fire the &#39;trait_added&#39; event:</span>
        <span class="k">if</span> <span class="n">old_trait</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trait_added</span> <span class="o">=</span> <span class="n">name</span>

    <span class="k">def</span> <span class="nf">remove_trait</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Removes a trait attribute from this object.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            Name of the attribute to remove.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        result : bool</span>
<span class="sd">            True if the trait was successfully removed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get the trait definition:</span>
        <span class="n">trait</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trait</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">trait</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="c1"># Check to see if the trait has additional sub-traits that need to</span>
            <span class="c1"># be removed also:</span>
            <span class="n">handler</span> <span class="o">=</span> <span class="n">trait</span><span class="o">.</span><span class="n">handler</span>
            <span class="k">if</span> <span class="n">handler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">handler</span><span class="o">.</span><span class="n">has_items</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">remove_trait</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_items&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">handler</span><span class="o">.</span><span class="n">is_mapped</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">remove_trait</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>

            <span class="c1"># Remove the trait value from the object dictionary as well:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

            <span class="c1"># Get the object&#39;s instance trait dictionary and remove the trait</span>
            <span class="c1"># from it:</span>
            <span class="n">itrait_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_instance_traits</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">itrait_dict</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">itrait_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">trait</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the trait definition for the *name* trait attribute.</span>

<span class="sd">        If *force* is False (the default) and *name* is the name of an</span>
<span class="sd">        implicitly defined trait attribute that has never been referenced</span>
<span class="sd">        explicitly (i.e., has not yet been defined), the result is None. In</span>
<span class="sd">        all other cases, the result is the trait definition object associated</span>
<span class="sd">        with *name*.</span>

<span class="sd">        If *copy* is True, and a valid trait definition is found for *name*,</span>
<span class="sd">        a copy of the trait found is returned. In all other cases, the trait</span>
<span class="sd">        definition found is returned unmodified (the default).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            Name of the attribute whose trait definition is to be returned.</span>
<span class="sd">        force : bool</span>
<span class="sd">            Indicates whether to return a trait definition if *name* is</span>
<span class="sd">            not explicitly defined.</span>
<span class="sd">        copy : bool</span>
<span class="sd">            Indicates whether to return the original trait definition or a</span>
<span class="sd">            copy.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">force</span><span class="p">:</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trait</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">copy</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="k">return</span> <span class="n">_clone_trait</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">base_trait</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the base trait definition for a trait attribute.</span>

<span class="sd">        This method is similar to the trait() method, and returns a</span>
<span class="sd">        different result only in the case where the trait attribute defined by</span>
<span class="sd">        *name* is a delegate. In this case, the base_trait() method follows the</span>
<span class="sd">        delegation chain until a non-delegated trait attribute is reached, and</span>
<span class="sd">        returns the definition of that attribute&#39;s trait as the result.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            Name of the attribute whose trait definition is returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trait</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">validate_trait</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Validates whether a value is legal for a trait.</span>

<span class="sd">        Returns the validated value if it is valid.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_trait</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">traits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a dictionary containing the definitions of all of the trait</span>
<span class="sd">        attributes of this object that match the set of *metadata* criteria.</span>
<span class="sd">        Note that any traits with a name containing the suffix &quot;_items&quot; are</span>
<span class="sd">        always excluded.</span>

<span class="sd">        The keys of the returned dictionary are the trait attribute names, and</span>
<span class="sd">        the values are their corresponding trait definition objects.</span>

<span class="sd">        If no *metadata* information is specified, then all explicitly defined</span>
<span class="sd">        trait attributes defined for the object are returned.</span>

<span class="sd">        Otherwise, the *metadata* keyword dictionary is assumed to define a set</span>
<span class="sd">        of search criteria for selecting trait attributes of interest. The</span>
<span class="sd">        *metadata* dictionary keys correspond to the names of trait metadata</span>
<span class="sd">        attributes to examine, and the values correspond to the values the</span>
<span class="sd">        metadata attribute must have in order to be included in the search</span>
<span class="sd">        results.</span>

<span class="sd">        The *metadata* values either may be simple Python values like strings</span>
<span class="sd">        or integers, or may be lambda expressions or functions that return True</span>
<span class="sd">        if the trait attribute is to be included in the result. A lambda</span>
<span class="sd">        expression or function must receive a single argument, which is the</span>
<span class="sd">        value of the trait metadata attribute being tested. If more than one</span>
<span class="sd">        metadata keyword is specified, a trait attribute must match the</span>
<span class="sd">        metadata values of all keywords to be included in the result.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        **metadata :</span>
<span class="sd">            Criteria for selecting trait attributes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">traits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__base_traits__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Update with instance-defined traits.</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">trt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_instance_traits</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">name</span><span class="p">[</span><span class="o">-</span><span class="mi">6</span><span class="p">:]</span> <span class="o">!=</span> <span class="s2">&quot;_items&quot;</span><span class="p">:</span>
                <span class="n">traits</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">trt</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">traits</span><span class="p">:</span>
                <span class="n">trait</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trait</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">trait</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">traits</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">trait</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">traits</span>

        <span class="k">for</span> <span class="n">meta_name</span><span class="p">,</span> <span class="n">meta_eval</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">meta_eval</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">FunctionType</span><span class="p">:</span>
                <span class="n">metadata</span><span class="p">[</span><span class="n">meta_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">_SimpleTest</span><span class="p">(</span><span class="n">meta_eval</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">trait</span> <span class="ow">in</span> <span class="n">traits</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">meta_name</span><span class="p">,</span> <span class="n">meta_eval</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">meta_eval</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">trait</span><span class="p">,</span> <span class="n">meta_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)):</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">trait</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">class_traits</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a dictionary containing the definitions of all of the trait</span>
<span class="sd">        attributes of the class that match the set of *metadata* criteria.</span>

<span class="sd">        The keys of the returned dictionary are the trait attribute names, and</span>
<span class="sd">        the values are their corresponding trait definition objects.</span>

<span class="sd">        If no *metadata* information is specified, then all explicitly defined</span>
<span class="sd">        trait attributes defined for the class are returned.</span>

<span class="sd">        Otherwise, the *metadata* keyword dictionary is assumed to define a set</span>
<span class="sd">        of search criteria for selecting trait attributes of interest. The</span>
<span class="sd">        *metadata* dictionary keys correspond to the names of trait metadata</span>
<span class="sd">        attributes to examine, and the values correspond to the values the</span>
<span class="sd">        metadata attribute must have in order to be included in the search</span>
<span class="sd">        results.</span>

<span class="sd">        The *metadata* values either may be simple Python values like strings</span>
<span class="sd">        or integers, or may be lambda expressions or functions that return</span>
<span class="sd">        **True** if the trait attribute is to be included in the result. A</span>
<span class="sd">        lambda expression or function must receive a single argument, which is</span>
<span class="sd">        the value of the trait metadata attribute being tested. If more than</span>
<span class="sd">        one metadata keyword is specified, a trait attribute must match the</span>
<span class="sd">        metadata values of all keywords to be included in the result.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        **metadata :</span>
<span class="sd">            Criteria for selecting trait attributes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__base_traits__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">meta_name</span><span class="p">,</span> <span class="n">meta_eval</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">meta_eval</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">FunctionType</span><span class="p">:</span>
                <span class="n">metadata</span><span class="p">[</span><span class="n">meta_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">_SimpleTest</span><span class="p">(</span><span class="n">meta_eval</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">trait</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__base_traits__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">meta_name</span><span class="p">,</span> <span class="n">meta_eval</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">meta_eval</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">trait</span><span class="p">,</span> <span class="n">meta_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)):</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">trait</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">trait_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a list of the names of all trait attributes whose</span>
<span class="sd">        definitions match the set of *metadata* criteria specified.</span>

<span class="sd">        This method is similar to the traits() method, but returns only the</span>
<span class="sd">        names of the matching trait attributes, not the trait definitions.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        **metadata :</span>
<span class="sd">            Criteria for selecting trait attributes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">traits</span><span class="p">(</span><span class="o">**</span><span class="n">metadata</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">class_trait_names</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a list of the names of all trait attributes whose</span>
<span class="sd">        definitions match the set of *metadata* criteria specified.</span>

<span class="sd">        This method is similar to the traits() method, but returns only the</span>
<span class="sd">        names of the matching trait attributes, not the trait definitions.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        **metadata :</span>
<span class="sd">            Criteria for selecting trait attributes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">class_traits</span><span class="p">(</span><span class="o">**</span><span class="n">metadata</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_set_traits_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Explicitly sets the value of a cached property.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cached</span> <span class="o">=</span> <span class="n">TraitsCache</span> <span class="o">+</span> <span class="n">name</span>
        <span class="n">old_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cached</span><span class="p">,</span> <span class="n">Undefined</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">cached</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">if</span> <span class="n">old_value</span> <span class="o">!=</span> <span class="n">value</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trait_property_changed</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">old_value</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_flush_traits_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Explicitly flushes the value of a cached property.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trait_property_changed</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">TraitsCache</span> <span class="o">+</span> <span class="n">name</span><span class="p">,</span> <span class="n">Undefined</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__prefix_trait__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">is_set</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the trait definition for a specified name when there is</span>
<span class="sd">        no explicit definition in the class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check to see if the name is of the form &#39;__xxx__&#39;:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;__&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span> <span class="o">==</span> <span class="s2">&quot;__&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;__class__&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">generic_trait</span>

            <span class="c1"># If this is for purposes of performing a &#39;setattr&#39;, always map the</span>
            <span class="c1"># name to an &#39;Any&#39; trait:</span>
            <span class="k">if</span> <span class="n">is_set</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">any_trait</span>

            <span class="c1"># Otherwise, it is a &#39;getattr&#39; request, so indicate that no such</span>
            <span class="c1"># attribute exists:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
                <span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39; object has no attribute &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span>
                <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Handle the special case of &#39;delegated&#39; traits:</span>
        <span class="k">if</span> <span class="n">name</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="o">==</span> <span class="s2">&quot;_&quot;</span><span class="p">:</span>
            <span class="n">trait</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trait</span><span class="p">(</span><span class="n">name</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">trait</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">trait</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;delegate&quot;</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">_clone_trait</span><span class="p">(</span><span class="n">trait</span><span class="p">)</span>

        <span class="n">prefix_traits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__prefix_traits__</span>
        <span class="k">for</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="n">prefix_traits</span><span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">prefix</span> <span class="o">==</span> <span class="n">name</span><span class="p">[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">)]:</span>
                <span class="c1"># If we found a match, use its trait as a template for a new</span>
                <span class="c1"># trait:</span>
                <span class="n">trait</span> <span class="o">=</span> <span class="n">prefix_traits</span><span class="p">[</span><span class="n">prefix</span><span class="p">]</span>

                <span class="c1"># Get any change notifiers that apply to the trait:</span>
                <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span>
                <span class="n">handlers</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">_get_method</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;_</span><span class="si">%s</span><span class="s2">_changed&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">),</span>
                    <span class="n">_get_method</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;_</span><span class="si">%s</span><span class="s2">_fired&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">),</span>
                <span class="p">]</span>

                <span class="c1"># Add any special trait defined event handlers:</span>
                <span class="n">_add_event_handlers</span><span class="p">(</span><span class="n">trait</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">handlers</span><span class="p">)</span>

                <span class="c1"># Add the &#39;anytrait&#39; handler (if any):</span>
                <span class="n">handlers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prefix_traits</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;@&quot;</span><span class="p">))</span>

                <span class="c1"># Filter out any &#39;None&#39; values:</span>
                <span class="n">handlers</span> <span class="o">=</span> <span class="p">[</span><span class="n">h</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">handlers</span> <span class="k">if</span> <span class="n">h</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>

                <span class="c1"># If there are any handlers, add them to the trait&#39;s notifier&#39;s</span>
                <span class="c1"># list:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">handlers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">trait</span> <span class="o">=</span> <span class="n">_clone_trait</span><span class="p">(</span><span class="n">trait</span><span class="p">)</span>
                    <span class="n">_add_notifiers</span><span class="p">(</span><span class="n">trait</span><span class="o">.</span><span class="n">_notifiers</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span> <span class="n">handlers</span><span class="p">)</span>

                <span class="k">return</span> <span class="n">trait</span>

        <span class="c1"># There should ALWAYS be a prefix match in the trait classes, since &#39;&#39;</span>
        <span class="c1"># is at the end of the list, so we should never get here:</span>
        <span class="k">raise</span> <span class="ne">SystemError</span><span class="p">(</span>
            <span class="s2">&quot;Trait class look-up failed for attribute &#39;</span><span class="si">%s</span><span class="s2">&#39; &quot;</span>
            <span class="s2">&quot;for an object of type &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_trait_listener</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">object</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Add (Java-style) event listener to an object. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_trait_listener</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">remove_trait_listener</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">object</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Remove (Java-style) event listener to an object. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_trait_listener</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_trait_listener</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">object</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">remove</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">prefix</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="o">!=</span> <span class="s2">&quot;_&quot;</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">+=</span> <span class="s2">&quot;_&quot;</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
        <span class="n">traits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__base_traits__</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_each_trait_method</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">name</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span> <span class="o">==</span> <span class="n">prefix</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span><span class="p">[</span><span class="o">-</span><span class="mi">8</span><span class="p">:]</span> <span class="o">==</span> <span class="s2">&quot;_changed&quot;</span><span class="p">:</span>
                    <span class="n">short_name</span> <span class="o">=</span> <span class="n">name</span><span class="p">[</span><span class="n">n</span><span class="p">:</span><span class="o">-</span><span class="mi">8</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">short_name</span> <span class="ow">in</span> <span class="n">traits</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_on_trait_change</span><span class="p">(</span>
                            <span class="nb">getattr</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="n">name</span><span class="p">),</span> <span class="n">short_name</span><span class="p">,</span> <span class="n">remove</span><span class="o">=</span><span class="n">remove</span>
                        <span class="p">)</span>
                    <span class="k">elif</span> <span class="n">short_name</span> <span class="o">==</span> <span class="s2">&quot;anytrait&quot;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_on_trait_change</span><span class="p">(</span>
                            <span class="nb">getattr</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="n">name</span><span class="p">),</span> <span class="n">remove</span><span class="o">=</span><span class="n">remove</span>
                        <span class="p">)</span>
                <span class="k">elif</span> <span class="n">name</span><span class="p">[:</span><span class="o">-</span><span class="mi">6</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;_fired&quot;</span><span class="p">:</span>
                    <span class="n">short_name</span> <span class="o">=</span> <span class="n">name</span><span class="p">[</span><span class="n">n</span><span class="p">:</span><span class="o">-</span><span class="mi">6</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">short_name</span> <span class="ow">in</span> <span class="n">traits</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_on_trait_change</span><span class="p">(</span>
                            <span class="nb">getattr</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="n">name</span><span class="p">),</span> <span class="n">short_name</span><span class="p">,</span> <span class="n">remove</span><span class="o">=</span><span class="n">remove</span>
                        <span class="p">)</span>
                    <span class="k">elif</span> <span class="n">short_name</span> <span class="o">==</span> <span class="s2">&quot;anytrait&quot;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_on_trait_change</span><span class="p">(</span>
                            <span class="nb">getattr</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="n">name</span><span class="p">),</span> <span class="n">remove</span><span class="o">=</span><span class="n">remove</span>
                        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_each_trait_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">object</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Generates each (name, method) pair for a specified object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dic</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">klass</span> <span class="ow">in</span> <span class="nb">object</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__mro__</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">klass</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">is_unbound_method_type</span><span class="p">(</span><span class="n">method</span><span class="p">)</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dic</span><span class="p">):</span>
                    <span class="n">dic</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">yield</span> <span class="n">name</span>

    <span class="k">def</span> <span class="nf">_instance_changed_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Handles adding/removing listeners for a generic &#39;Instance&#39; trait.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">arg_lists</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_instance_handlers</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">old</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">args</span> <span class="ow">in</span> <span class="n">arg_lists</span><span class="p">:</span>
                <span class="n">old</span><span class="o">.</span><span class="n">on_trait_change</span><span class="p">(</span><span class="n">remove</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">new</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">args</span> <span class="ow">in</span> <span class="n">arg_lists</span><span class="p">:</span>
                <span class="n">new</span><span class="o">.</span><span class="n">on_trait_change</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_list_changed_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Handles adding/removing listeners for a generic &#39;List( Instance )&#39;</span>
<span class="sd">            trait.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">arg_lists</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_instance_handlers</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">old</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">args</span> <span class="ow">in</span> <span class="n">arg_lists</span><span class="p">:</span>
                <span class="n">item</span><span class="o">.</span><span class="n">on_trait_change</span><span class="p">(</span><span class="n">remove</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">new</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">args</span> <span class="ow">in</span> <span class="n">arg_lists</span><span class="p">:</span>
                <span class="n">item</span><span class="o">.</span><span class="n">on_trait_change</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_list_items_changed_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">not_used</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Handles adding/removing listeners for a generic &#39;List( Instance )&#39;</span>
<span class="sd">            trait.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">arg_lists</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_instance_handlers</span><span class="p">(</span><span class="n">name</span><span class="p">[:</span><span class="o">-</span><span class="mi">6</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">event</span><span class="o">.</span><span class="n">removed</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">args</span> <span class="ow">in</span> <span class="n">arg_lists</span><span class="p">:</span>
                <span class="n">item</span><span class="o">.</span><span class="n">on_trait_change</span><span class="p">(</span><span class="n">remove</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">event</span><span class="o">.</span><span class="n">added</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">args</span> <span class="ow">in</span> <span class="n">arg_lists</span><span class="p">:</span>
                <span class="n">item</span><span class="o">.</span><span class="n">on_trait_change</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_instance_handlers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns a list of ( name, method ) pairs for a specified &#39;Instance&#39;</span>
<span class="sd">            or &#39;List( Instance )&#39; trait name:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method_name</span><span class="p">),</span> <span class="n">item_name</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">method_name</span><span class="p">,</span> <span class="n">item_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">__instance_traits__</span><span class="p">[</span>
                <span class="n">name</span>
            <span class="p">]</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="nf">_post_init_trait_listeners</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Initializes the object&#39;s statically parsed, but dynamically</span>
<span class="sd">            registered, traits listeners (called at object creation and</span>
<span class="sd">            unpickling times).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">__listener_traits__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;method&quot;</span><span class="p">:</span>
                <span class="n">config</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;post_init&quot;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">on_trait_change</span><span class="p">(</span>
                        <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">),</span>
                        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;pattern&quot;</span><span class="p">],</span>
                        <span class="n">deferred</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">dispatch</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;dispatch&quot;</span><span class="p">],</span>
                    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_init_trait_listeners</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Initializes the object&#39;s statically parsed, but dynamically</span>
<span class="sd">            registered, traits listeners (called at object creation and</span>
<span class="sd">            unpickling times).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">__listener_traits__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_init_trait_</span><span class="si">%s</span><span class="s2">_listener&quot;</span> <span class="o">%</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])(</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_init_trait_method_listener</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Sets up the listener for a method with the @on_trait_change</span>
<span class="sd">            decorator.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;post_init&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">on_trait_change</span><span class="p">(</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">),</span>
                <span class="n">config</span><span class="p">[</span><span class="s2">&quot;pattern&quot;</span><span class="p">],</span>
                <span class="n">deferred</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">dispatch</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;dispatch&quot;</span><span class="p">],</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_init_trait_event_listener</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">pattern</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Sets up the listener for an event with on_trait_change metadata.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nd">@weak_arg</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">notify</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">on_trait_change</span><span class="p">(</span><span class="n">notify</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_init_trait_property_listener</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">cached</span><span class="p">,</span> <span class="n">pattern</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Sets up the listener for a property with &#39;depends_on&#39; metadata.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">cached</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

            <span class="nd">@weak_arg</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">def</span> <span class="nf">notify</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trait_property_changed</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">cached_old</span> <span class="o">=</span> <span class="n">cached</span> <span class="o">+</span> <span class="s2">&quot;:old&quot;</span>

            <span class="nd">@weak_arg</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">def</span> <span class="nf">pre_notify</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="nb">dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span>
                <span class="n">old</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cached_old</span><span class="p">,</span> <span class="n">Undefined</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">old</span> <span class="ow">is</span> <span class="n">Undefined</span><span class="p">:</span>
                    <span class="nb">dict</span><span class="p">[</span><span class="n">cached_old</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">cached</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">on_trait_change</span><span class="p">(</span>
                <span class="n">pre_notify</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="bp">self</span>
            <span class="p">)</span>

            <span class="nd">@weak_arg</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">def</span> <span class="nf">notify</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="n">old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">cached_old</span><span class="p">,</span> <span class="n">Undefined</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">old</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">Undefined</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">trait_property_changed</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">old</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">on_trait_change</span><span class="p">(</span><span class="n">notify</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_init_trait_delegate_listener</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">pattern</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Sets up the listener for a delegate trait.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name_pattern</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trait_delegate_name</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">pattern</span><span class="p">)</span>
        <span class="n">target_name_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">name_pattern</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="nd">@weak_arg</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">notify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">object</span><span class="p">,</span> <span class="n">notify_name</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trait_property_changed</span><span class="p">(</span>
                <span class="n">name</span> <span class="o">+</span> <span class="n">notify_name</span><span class="p">[</span><span class="n">target_name_len</span><span class="p">:],</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">on_trait_change</span><span class="p">(</span><span class="n">notify</span><span class="p">,</span> <span class="n">name_pattern</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">ListenerTraits</span><span class="p">,</span> <span class="p">{})[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">notify</span>

    <span class="k">def</span> <span class="nf">_remove_trait_delegate_listener</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">remove</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Removes a delegate listener when the local delegate value is set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">ListenerTraits</span><span class="p">,</span> <span class="p">{})</span>

        <span class="k">if</span> <span class="n">remove</span><span class="p">:</span>
            <span class="c1"># Although the name should be in the dict, it may not be if a value</span>
            <span class="c1"># was assigned to a delegate in a constructor or setstate:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">dict</span><span class="p">:</span>
                <span class="c1"># Remove the delegate listener:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">on_trait_change</span><span class="p">(</span>
                    <span class="nb">dict</span><span class="p">[</span><span class="n">name</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_trait_delegate_name</span><span class="p">(</span>
                        <span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">__listener_traits__</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                    <span class="p">),</span>
                    <span class="n">remove</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">del</span> <span class="nb">dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">ListenerTraits</span><span class="p">]</span>

            <span class="k">return</span>

        <span class="c1"># Otherwise the local copy of the delegate value was deleted, restore</span>
        <span class="c1"># the delegate listener (unless it&#39;s already there):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_trait_delegate_listener</span><span class="p">(</span>
                <span class="n">name</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">__listener_traits__</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_init_trait_observers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Initialize observers prior to setting object state.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">states</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">__observer_traits__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">states</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;post_init&quot;</span><span class="p">]:</span>
                    <span class="n">observe_api</span><span class="o">.</span><span class="n">apply_observers</span><span class="p">(</span>
                        <span class="nb">object</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                        <span class="n">handler</span><span class="o">=</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;handler_getter&quot;</span><span class="p">](</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">),</span>
                        <span class="n">graphs</span><span class="o">=</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;graphs&quot;</span><span class="p">],</span>
                        <span class="n">dispatcher</span><span class="o">=</span><span class="n">_ObserverDispatchers</span><span class="p">[</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;dispatch&quot;</span><span class="p">]],</span>
                    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_post_init_trait_observers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Initialize observers after setting object state.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">states</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">__observer_traits__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">states</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;post_init&quot;</span><span class="p">]:</span>
                    <span class="n">observe_api</span><span class="o">.</span><span class="n">apply_observers</span><span class="p">(</span>
                        <span class="nb">object</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                        <span class="n">handler</span><span class="o">=</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;handler_getter&quot;</span><span class="p">](</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">),</span>
                        <span class="n">graphs</span><span class="o">=</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;graphs&quot;</span><span class="p">],</span>
                        <span class="n">dispatcher</span><span class="o">=</span><span class="n">_ObserverDispatchers</span><span class="p">[</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;dispatch&quot;</span><span class="p">]],</span>
                    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_trait_delegate_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">pattern</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the fully-formed &#39;on_trait_change&#39; name for a specified</span>
<span class="sd">            delegate.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">pattern</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;*&quot;</span><span class="p">:</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">pattern</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">__prefix__</span><span class="p">,</span>
                <span class="n">name</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">pattern</span>


<span class="c1"># Patch the definition of _HasTraits to be the real &#39;HasTraits&#39;:</span>
<span class="n">_HasTraits</span> <span class="o">=</span> <span class="n">HasTraits</span>


<span class="k">class</span> <span class="nc">HasStrictTraits</span><span class="p">(</span><span class="n">HasTraits</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; This class guarantees that any object attribute that does not have an</span>
<span class="sd">    explicit or wildcard trait definition results in an exception.</span>

<span class="sd">    This feature can be useful in cases where a more rigorous software</span>
<span class="sd">    engineering approach is being used than is typical for Python programs. It</span>
<span class="sd">    also helps prevent typos and spelling mistakes in attribute names from</span>
<span class="sd">    going unnoticed; a misspelled attribute name typically causes an exception.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_</span> <span class="o">=</span> <span class="n">Disallow</span>  <span class="c1"># Disallow access to any traits not explicitly defined</span>


<span class="k">class</span> <span class="nc">HasRequiredTraits</span><span class="p">(</span><span class="n">HasStrictTraits</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; This class builds on the functionality of HasStrictTraits and ensures</span>
<span class="sd">    that any object attribute with `required=True` in its metadata must be</span>
<span class="sd">    passed as an argument on object initialization.</span>

<span class="sd">    This can be useful in cases where an object has traits which are required</span>
<span class="sd">    for it to function correctly.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    TraitError</span>
<span class="sd">        If a required trait is not passed as an argument.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    A class with required traits:</span>

<span class="sd">    &gt;&gt;&gt; class RequiredTest(HasRequiredTraits):</span>
<span class="sd">    ...     required_trait = Any(required=True)</span>
<span class="sd">    ...     non_required_trait = Any()</span>

<span class="sd">    Creating an instance of a HasRequiredTraits subclass:</span>

<span class="sd">    &gt;&gt;&gt; test_instance = RequiredTest(required_trait=13, non_required_trait=11)</span>
<span class="sd">    &gt;&gt;&gt; test_instance2 = RequiredTest(required_trait=13)</span>

<span class="sd">    Forgetting to specify a required trait:</span>

<span class="sd">    &gt;&gt;&gt; test_instance = RequiredTest(non_required_trait=11)</span>
<span class="sd">    traits.trait_errors.TraitError: The following required traits were not</span>
<span class="sd">    provided: required_trait.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">traits</span><span class="p">):</span>

        <span class="n">missing_required_traits</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">name</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trait_names</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">traits</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">missing_required_traits</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">TraitError</span><span class="p">(</span>
                <span class="s2">&quot;The following required traits were not provided: &quot;</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">missing_required_traits</span><span class="p">)))</span>
            <span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">traits</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">HasPrivateTraits</span><span class="p">(</span><span class="n">HasTraits</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; This class ensures that any public object attribute that does not have</span>
<span class="sd">    an explicit or wildcard trait definition results in an exception, but</span>
<span class="sd">    &quot;private&quot; attributes (whose names start with &#39;_&#39;) have an initial value of</span>
<span class="sd">    **None**, and are not type-checked.</span>

<span class="sd">    This feature is useful in cases where a class needs private attributes to</span>
<span class="sd">    keep track of its internal object state, which are not part of the class&#39;s</span>
<span class="sd">    public API. Such attributes do not need to be type-checked, because they</span>
<span class="sd">    are manipulated only by the (presumably correct) methods of the class</span>
<span class="sd">    itself.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Make &#39;private&#39; traits (leading &#39;_&#39;) have no type checking:</span>
    <span class="n">__</span> <span class="o">=</span> <span class="n">Any</span><span class="p">(</span><span class="n">private</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">transient</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Disallow access to all other traits not explicitly defined:</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">Disallow</span>


<span class="c1"># ABC classes with traits</span>

<span class="k">class</span> <span class="nc">ABCMetaHasTraits</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABCMeta</span><span class="p">,</span> <span class="n">MetaHasTraits</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; A MetaHasTraits subclass which also inherits from</span>
<span class="sd">    abc.ABCMeta.</span>

<span class="sd">    .. note:: The ABCMeta class is cooperative and behaves nicely</span>
<span class="sd">        with MetaHasTraits, provided it is inherited first.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">ABCHasTraits</span><span class="p">(</span><span class="n">HasTraits</span><span class="p">,</span> <span class="n">metaclass</span><span class="o">=</span><span class="n">ABCMetaHasTraits</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; A HasTraits subclass which enables the features of Abstract</span>
<span class="sd">    Base Classes (ABC). See the &#39;abc&#39; module in the standard library</span>
<span class="sd">    for more information.</span>

<span class="sd">    &quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">ABCHasStrictTraits</span><span class="p">(</span><span class="n">ABCHasTraits</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; A HasTraits subclass which behaves like HasStrictTraits but</span>
<span class="sd">    also enables the features of Abstract Base Classes (ABC). See the</span>
<span class="sd">    &#39;abc&#39; module in the standard library for more information.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_</span> <span class="o">=</span> <span class="n">Disallow</span>


<span class="c1">#  Singleton classes with traits:</span>
<span class="c1">#</span>
<span class="c1">#  This code is based on a recipe taken from:</span>
<span class="c1">#      http://aspn.activestate.com/ASPN/Cookbook/Python/Recipe/66531</span>
<span class="c1">#  Specifically, the implementation of Oren Tirosh is used.</span>

<span class="k">class</span> <span class="nc">SingletonHasTraits</span><span class="p">(</span><span class="n">HasTraits</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Singleton class that support trait attributes.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@deprecated</span><span class="p">(</span><span class="s2">&quot;SingletonHasTraits has been deprecated and will be removed &quot;</span>
                <span class="s2">&quot;in the future. Avoid using it&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">traits</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;_the_instance&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_the_instance</span> <span class="o">=</span> <span class="n">HasTraits</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">traits</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_the_instance</span>


<span class="k">class</span> <span class="nc">SingletonHasStrictTraits</span><span class="p">(</span><span class="n">HasStrictTraits</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Singleton class that supports strict trait attributes.</span>

<span class="sd">        Non-trait attributes generate an exception.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@deprecated</span><span class="p">(</span><span class="s2">&quot;SingletonHasStrictTraits has been deprecated and will be &quot;</span>
                <span class="s2">&quot;removed in the future. Avoid using it&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">traits</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">SingletonHasTraits</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">traits</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">SingletonHasPrivateTraits</span><span class="p">(</span><span class="n">HasPrivateTraits</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Singleton class that supports trait attributes, with private attributes</span>
<span class="sd">        being unchecked.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@deprecated</span><span class="p">(</span><span class="s2">&quot;SingletonHasPrivateTraits has been deprecated and will be &quot;</span>
                <span class="s2">&quot;removed in the future. Avoid using it&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">traits</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">SingletonHasTraits</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">traits</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Vetoable</span><span class="p">(</span><span class="n">HasStrictTraits</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Defines a &#39;vetoable&#39; request object and an associated event.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Should the request be vetoed? (Can only be set to &#39;True&#39;)</span>
    <span class="n">veto</span> <span class="o">=</span> <span class="n">Bool</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_veto_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_trait_veto_notify</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>


<span class="n">VetoableEvent</span> <span class="o">=</span> <span class="n">Event</span><span class="p">(</span><span class="n">Vetoable</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">MetaInterface</span><span class="p">(</span><span class="n">ABCMetaHasTraits</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Meta class for interfaces.</span>

<span class="sd">    Interfaces are simple ABCs with the following features:-</span>

<span class="sd">    1) They cannot be instantiated (they are interfaces, not implementations!).</span>
<span class="sd">    2) Calling them is equivalent to calling &#39;adapt&#39;.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@deprecated</span><span class="p">(</span><span class="s1">&#39;use &quot;adapt(adaptee, protocol)&quot; instead.&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">adaptee</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">AdaptationError</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Attempt to adapt the adaptee to this interface.</span>

<span class="sd">        Note that this means that (intentionally ;^) that interfaces</span>
<span class="sd">        cannot be instantiated!</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">traits.adaptation.api</span> <span class="kn">import</span> <span class="n">adapt</span>

        <span class="k">return</span> <span class="n">adapt</span><span class="p">(</span><span class="n">adaptee</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Interface</span><span class="p">(</span><span class="n">HasTraits</span><span class="p">,</span> <span class="n">metaclass</span><span class="o">=</span><span class="n">MetaInterface</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; The base class for all interfaces.</span>
<span class="sd">    &quot;&quot;&quot;</span>


<span class="k">def</span> <span class="nf">provides</span><span class="p">(</span><span class="o">*</span><span class="n">protocols</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Class decorator to declare the protocols that a class provides.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    *protocols :</span>
<span class="sd">        A list of protocols (Interface classes or Python ABCs) that the</span>
<span class="sd">        decorated class provides.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABCMeta</span>

    <span class="c1"># Exit immediately if there is nothing to do.</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">protocols</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">lambda</span> <span class="n">klass</span><span class="p">:</span> <span class="n">klass</span>

    <span class="c1"># Verify that each argument is a valid protocol.</span>
    <span class="k">for</span> <span class="n">protocol</span> <span class="ow">in</span> <span class="n">protocols</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">protocol</span><span class="p">),</span> <span class="n">ABCMeta</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">TraitError</span><span class="p">(</span>
                <span class="s2">&quot;All arguments to &#39;provides&#39; must be &quot;</span>
                <span class="s2">&quot;subclasses of Interface or be a Python ABC.&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">wrapped_class</span><span class="p">(</span><span class="n">klass</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">protocol</span> <span class="ow">in</span> <span class="n">protocols</span><span class="p">:</span>
            <span class="c1"># We use &#39;type(protocol)&#39; in case the &#39;protocol&#39; implements</span>
            <span class="c1"># its own &#39;register&#39; method that overrides the ABC method.</span>
            <span class="nb">type</span><span class="p">(</span><span class="n">protocol</span><span class="p">)</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">protocol</span><span class="p">,</span> <span class="n">klass</span><span class="p">)</span>

        <span class="c1"># Make sure the class does provide the protocols it claims to.</span>
        <span class="k">if</span> <span class="n">CHECK_INTERFACES</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">.interface_checker</span> <span class="kn">import</span> <span class="n">check_implements</span>

            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="s2">&quot;In the future, the @provides decorator will not perform &quot;</span>
                    <span class="s2">&quot;interface checks. Set has_traits.CHECK_INTERFACES to 0 &quot;</span>
                    <span class="s2">&quot;to suppress this warning.&quot;</span>
                <span class="p">),</span>
                <span class="ne">DeprecationWarning</span><span class="p">,</span>
                <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">check_implements</span><span class="p">(</span><span class="n">klass</span><span class="p">,</span> <span class="n">protocols</span><span class="p">,</span> <span class="n">CHECK_INTERFACES</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">klass</span>

    <span class="k">return</span> <span class="n">wrapped_class</span>


<span class="k">def</span> <span class="nf">isinterface</span><span class="p">(</span><span class="n">klass</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Return True if the class is an Interface. &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">klass</span><span class="p">,</span> <span class="n">MetaInterface</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ISerializable</span><span class="p">(</span><span class="n">Interface</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; A class that implemented ISerializable requires that all HasTraits</span>
<span class="sd">        objects saved as part of its state also implement ISerializable.</span>
<span class="sd">    &quot;&quot;&quot;</span>
</pre></div>

              </div>
              
              
          </main>
          

      </div>
    </div>
  
  <script src="../../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2021, PMEAL.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.3.1.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>