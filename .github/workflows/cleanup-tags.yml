name: ðŸ”§ Clean up tags

on: push

jobs:
  deploy:
    name: Clean up tags
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2

    - name: Test GitHub Actions new set-env API
      run: |
        source utils.sh
        get_most_recent_tag
        git tag | sort -V | tail -1
        echo "x<<EOF" >> $GITHUB_ENV
        get_most_recent_tag >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV
        tempvar=123456
        echo "z=$tempvar" >> $GITHUB_ENV
        echo "y=1234" >> $GITHUB_ENV

    - name: Clean up tags
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        REPOSITORY=${INPUT_REPOSITORY:-$GITHUB_REPOSITORY}
        remote_repo="https://${GITHUB_ACTOR}:${{ secrets.GITHUB_TOKEN }}@github.com/${REPOSITORY}.git"
        git fetch --all --tags
        prefix="v"
        pattern="^($prefix)(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)(?:-((?:0|[1-9][0-9]*|[0-9]*[a-zA-Z-][0-9a-zA-Z-]*)(?:\.(?:0|[1-9][0-9]*|[0-9]*[a-zA-Z-][0-9a-zA-Z-]*))*))?(?:\+([0-9a-zA-Z-]+(?:\.[0-9a-zA-Z-]+)*))?$"
        git tag | grep --invert-match -P $pattern | xargs -n 1 -I % git push "${remote_repo}" :refs/tags/%
